<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro V29.31</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; }
        
        /* PANTALLA DE LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            z-index: 2000; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; color: white;
            padding: 20px; box-sizing: border-box; text-align: center;
        }
        .login-logo { font-size: 4rem; margin-bottom: 20px; }
        .login-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .login-desc { font-size: 1rem; opacity: 0.9; margin-bottom: 40px; max-width: 300px; }
        
        .btn-google {
            background: white; color: #333; border: none; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; font-size: 1rem;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .btn-google:active { transform: scale(0.95); }
        .btn-google img { width: 20px; height: 20px; }

        /* HEADER APP */
        header { 
            background-color: #2e7d32; padding: 8px 15px 12px 15px; 
            display: flex; flex-direction: column; align-items: center; 
            position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: background-color 0.3s;
        }
        header.offline { background-color: #455a64; }

        /* BARRA SUPERIOR (Estado + Sync + Perfil) */
        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        
        .connection-badge {
            font-size: 0.75rem; color: white; background: rgba(0,0,0,0.2); 
            padding: 4px 8px; border-radius: 12px; display: none;
        }
        
        /* BOT√ìN DE SINCRONIZACI√ìN */
        .sync-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; border-radius: 15px; padding: 4px 10px; font-size: 0.8rem;
            cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 500;
        }
        .sync-btn.pending { background: #ff9800; border-color: #f57c00; animation: pulse-border 2s infinite; color: white; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(255, 152, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); } }

        .user-profile { display: flex; align-items: center; gap: 8px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; cursor: pointer;}
        
        /* BOT√ìN RESET */
        .reset-btn {
            background: none; border: none; font-size: 1.2rem; cursor: pointer; 
            padding: 0 5px; opacity: 0.8;
        }

        /* SELECTOR COMPACTO */
        #store-select {
            font-size: 0.9rem; padding: 4px 12px; border-radius: 20px; border: none; 
            font-weight: 600; width: auto; min-width: 150px; max-width: 80%;
            text-align: center; text-align-last: center;
            background: rgba(255,255,255,0.9); color: #1b5e20; outline: none; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); margin-bottom: 8px; 
            -webkit-appearance: none; appearance: none;
        }

        .header-controls { display: flex; gap: 8px; width: 100%; max-width: 400px; }
        .btn-main, .btn-secondary {
            flex: 1; padding: 10px; border: none; border-radius: 8px; 
            font-size: 0.9rem; font-weight: bold; cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; 
            align-items: center; justify-content: center; gap: 6px;
        }
        .btn-main { background-color: white; color: #2e7d32; }
        .btn-secondary { background-color: rgba(255,255,255,0.25); color: white; }

        /* CONTENIDO PRINCIPAL */
        #app-content { display: none; }

        #scanner-container { width: 100%; background: black; min-height: 250px; position: relative; overflow: hidden; display: none; }
        #reader video { width: 100%; height: auto; object-fit: contain !important; }
        
        .dashboard { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        
        .total-box { 
            background: white; padding: 20px; border-radius: 12px; text-align: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; border: 2px solid transparent;
            transition: all 0.3s ease; position: relative; margin-top: 5px; 
        }
        .total-price { font-size: 2.5rem; font-weight: 800; color: #2e7d32; margin-top: 5px; transition: color 0.3s; }
        .total-price.warning { color: #f57c00; }
        .total-price.danger { color: #d32f2f; animation: pulse 1s infinite; }
        .total-box.danger { border-color: #d32f2f; background-color: #ffebee; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* MODIFICADO: CONTROL DE PRESUPUESTO */
        .budget-control { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; color: #555; }
        .budget-input { 
            width: 100px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; 
            text-align: center; font-size: 1rem; color: #333; margin-bottom: 0; font-weight: bold; 
        }
        .btn-clear-cart { margin-top: 15px; background: none; border: 1px solid #ffcdd2; color: #c62828; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }

        .product-list { list-style: none; padding: 0; }
        .category-header { background: #e8f5e9; color: #2e7d32; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
        .product-item { background: white; border-bottom: 1px solid #f0f0f0; padding: 15px; display: flex; justify-content: space-between; align-items: center; animation: fadeIn 0.3s ease; }
        .item-qty-badge { background: #2e7d32; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-right: 5px; }
        .btn-delete { background: #ffcdd2; color: #c62828; border: none; padding: 8px 12px; border-radius: 6px; margin-left: 10px; cursor: pointer; font-size: 1.2rem; }

        /* Estilos de Estado en Historial */
        .status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px; text-transform: uppercase; }
        .status-badge.approved { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .status-badge.rejected { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .status-badge.pending { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        /* Estilos de Comparaci√≥n */
        .comp-badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; font-weight: bold; display: inline-flex; align-items: center; gap: 4px; }
        .comp-badge.cheaper { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .comp-badge.expensive { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }

        .modal { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 25px 20px; border-radius: 20px 20px 0 0; z-index: 101; box-shadow: 0 -4px 30px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        input, select { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 1.1rem; box-sizing: border-box; margin-bottom: 15px; -webkit-appearance: none; }
        select { background-color: white; }
        #modal-barcode { font-family: monospace; font-size: 0.9rem; color: #666; background: #f9f9f9; margin-bottom: 10px; border: 1px dashed #ccc; }
        
        /* SELECTOR UNIDAD (NUEVO) */
        .unit-selector { display: flex; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .unit-option { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #f9f9f9; border: none; font-weight: 500; font-size: 0.9rem; }
        .unit-option.active { background: #2e7d32; color: white; font-weight: bold; }

        .qty-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: #f5f5f5; padding: 10px; border-radius: 8px; }
        .qty-controls { display: flex; align-items: center; gap: 15px; width: 50%; justify-content: flex-end; }
        .btn-qty { width: 40px; height: 40px; border-radius: 50%; border: none; background: #fff; color: #2e7d32; font-size: 1.5rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #qty-display { font-size: 1.5rem; font-weight: bold; min-width: 30px; text-align: center; }
        
        /* Input especial para KG */
        #inp-qty-kg { width: 100px; text-align: center; margin: 0; font-weight: bold; font-size: 1.2rem; }

        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .btn-confirm { flex: 2; background: #2e7d32; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-cancel { flex: 1; background: #f5f5f5; color: #333; padding: 15px; border: none; border-radius: 8px; font-weight: bold; }

        .btn-compare { background: #e3f2fd; color: #1565c0; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: 600; margin-bottom: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-compare:active { background: #bbdefb; }

        #search-results { list-style: none; padding: 0; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .search-result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 200; left: 50%; bottom: 30px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-weight: 500; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast.success { background-color: #2e7d32; }
        #toast.alert { background-color: #d32f2f; }
        #overlay-bg { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 100; }
    </style>
</head>
<body>

<!-- PANTALLA DE LOGIN -->
<div id="login-screen">
    <div class="login-logo">üõí</div>
    <div class="login-title">Scanner Pro</div>
    <div class="login-desc">Tu asistente inteligente para compras de supermercado.</div>
    <button class="btn-google" onclick="signInWithGoogle()">
        <img src="https://cdn-icons-png.flaticon.com/512/300/300221.png" alt="G">
        Ingresar con Google
    </button>
</div>

<!-- APP PRINCIPAL -->
<div id="app-content">
    <header id="app-header">
        <div class="top-bar">
            <div id="connection-status" class="connection-badge">üì° Offline</div>
            <button id="sync-btn" class="sync-btn" onclick="syncOfflineData()">‚òÅÔ∏è Al d√≠a</button>
            <div class="user-profile" id="user-profile"></div>
            <!-- BOT√ìN RESET (NUEVO) -->
            <button class="reset-btn" onclick="resetApp()" title="Reparar App">üõ†Ô∏è</button>
        </div>

        <select id="store-select" onchange="handleStoreChange()">
            <option value="lider">üîµ Lider</option>
            <option value="jumbo">üêò Jumbo</option>
            <option value="unimarc">üî¥ Unimarc</option>
            <option value="tottus">üü¢ Tottus</option>
            <option value="acuenta">üõí aCuenta</option>
            <option value="santa_isabel">üêº Santa Isabel</option>
            <option value="mayorista">üì¶ Mayorista</option>
            <option value="otro">üè™ Almac√©n / Otro</option>
        </select>
        <div class="header-controls">
            <button id="start-btn" class="btn-main" onclick="startScanner()">üì∑ Escanear</button>
            <button class="btn-secondary" onclick="openSearchModal()">‚úçÔ∏è Manual</button>
        </div>
    </header>

    <div id="scanner-container">
        <div id="reader"></div>
        <button onclick="stopScanner()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; padding:5px 10px; border-radius:4px;">Cerrar X</button>
    </div>

    <div class="dashboard">
        <div class="total-box">
            <small>Total Carrito</small>
            <div class="total-price" id="total-amount">$0</div>
            
            <!-- CAMPO META -->
            <div class="budget-control">
                <span>Meta: $</span>
                <input type="text" inputmode="numeric" class="budget-input" id="budget-limit" placeholder="..." oninput="handleBudgetInput(this)">
            </div>
            
            <button class="btn-clear-cart" onclick="clearCart()">üóëÔ∏è Vaciar Carrito</button>
        </div>
        <ul class="product-list" id="cart-list"></ul>
    </div>
</div>

<div id="overlay-bg" onclick="closeAllModals()"></div>

<!-- MODAL B√öSQUEDA -->
<div id="search-modal" class="modal">
    <div class="modal-header"><strong>üîç Buscar o Crear</strong></div>
    <input type="text" id="search-input" placeholder="Nombre o C√≥digo..." onkeyup="handleSearchTyping(this.value)">
    <ul id="search-results"></ul>
    <button class="btn-main" id="btn-create-manual" style="display:none; margin-top: 15px; background-color: #1976d2; color:white; box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3); width: 100%;" onclick="createManualItem()">‚ûï Crear Nuevo</button>
    <button class="btn-cancel" style="width:100%; margin-top:10px;" onclick="closeAllModals()">Cerrar</button>
</div>

<!-- MODAL PRODUCTO -->
<div id="product-modal" class="modal">
    <div class="modal-header">
        <strong>üìù Detalle Producto</strong>
        <span id="store-badge" style="background:#e3f2fd; color:#1565c0; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;"></span>
    </div>
    
    <div id="comparison-alert" class="price-alert"></div>
    
    <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding: 0 5px;">
        <button onclick="openComparisonModal()" style="background:none; border:none; color:#1976d2; font-size:0.9rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px; padding:0;">
            <span>üîç Comparar Precios</span>
        </button>
        
        <button onclick="openHistoryModal()" style="background:none; border:none; color:#1976d2; font-size:0.9rem; font-weight:600; cursor:pointer; display:flex; align-items:center; gap:5px; padding:0;">
            <span>üìâ Ver Historial</span>
        </button>
    </div>

    <label style="font-size:0.8rem; color:#666;">C√≥digo:</label>
    <input type="text" id="modal-barcode" disabled>
    <input type="text" id="inp-name" placeholder="Nombre (ej: Leche)" autocomplete="off">
    <!-- INPUT PRECIO MODIFICADO -->
    <input type="text" id="inp-price" placeholder="Precio Unidad ($)" inputmode="numeric" oninput="formatCurrencyInput(this)">
    
    <!-- SELECTOR DE UNIDAD -->
    <div class="unit-selector">
        <button type="button" id="btn-unit-un" class="unit-option active" onclick="setUnitType('UN')">Unidad (x1)</button>
        <button type="button" id="btn-unit-kg" class="unit-option" onclick="setUnitType('KG')">Granel (Kg)</button>
    </div>

    <select id="inp-category">
        <option value="despensa">ü•´ Despensa</option>
        <option value="lacteos">üßÄ L√°cteos y Huevos</option>
        <option value="frutas">ü•¶ Frutas y Verduras</option>
        <option value="carnes">ü•© Carnes y Pescados</option>
        <option value="panaderia">üçû Panader√≠a</option>
        <option value="bebidas">ü•§ Bebidas</option>
        <option value="snack">üç™ Snacks y Dulces</option>
        <option value="alcohol">üç∑ Cervezas y Licores</option>
        <option value="aseo">üßπ Limpieza y Aseo</option>
        <option value="personal">üß¥ Cuidado Personal</option>
        <option value="mascotas">üê∂ Mascotas</option>
        <option value="hogar">üè† Hogar</option>
        <option value="otros" selected>üì¶ Otros</option>
    </select>
    
    <div class="qty-wrapper">
        <span id="qty-label" style="font-weight:bold; color:#555;">Cantidad:</span>
        <!-- CONTROLES DIN√ÅMICOS -->
        <div id="qty-controls-un" class="qty-controls">
            <button class="btn-qty" onclick="adjustQty(-1)">‚àí</button>
            <span id="qty-display">1</span>
            <button class="btn-qty" onclick="adjustQty(1)">+</button>
        </div>
        <div id="qty-controls-kg" class="qty-controls" style="display:none;">
            <input type="text" inputmode="demcimal" id="inp-qty-kg" placeholder="0.000" step="0.001">
            <span style="font-weight:bold;">kg</span>
        </div>
    </div>
    
    <div class="modal-btns">
        <button class="btn-cancel" onclick="closeAllModals()">Cancelar</button>
        <button class="btn-confirm" onclick="saveAndAdd()">Guardar</button>
    </div>
</div>

<!-- MODAL HISTORIAL -->
<div id="history-modal" class="modal" style="z-index: 200;">
    <div class="modal-header">
        <strong>üìâ Historial de Reportes</strong>
        <button onclick="document.getElementById('history-modal').style.display='none'" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">√ó</button>
    </div>
    <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">Cambios significativos (√∫ltimos 30):</div>
    <ul id="history-list" class="product-list" style="max-height: 300px; overflow-y: auto;">
        <li style="padding:10px; color:#666;">Cargando...</li>
    </ul>
    <button class="btn-cancel" style="width:100%; margin-top:10px;" onclick="document.getElementById('history-modal').style.display='none'">Cerrar</button>
</div>

<!-- MODAL COMPARACI√ìN -->
<div id="comparison-modal" class="modal" style="z-index: 200;">
    <div class="modal-header">
        <strong>üîç Comparaci√≥n de Precios</strong>
        <button onclick="document.getElementById('comparison-modal').style.display='none'" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">√ó</button>
    </div>
    <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">Precios en otros supermercados:</div>
    <ul id="comparison-list" class="product-list" style="max-height: 300px; overflow-y: auto;">
        <li style="padding:10px; color:#666;">Buscando...</li>
    </ul>
    <button class="btn-cancel" style="width:100%; margin-top:10px;" onclick="document.getElementById('comparison-modal').style.display='none'">Cerrar</button>
</div>

<div id="toast">Mensaje...</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è IMPORTANTE: PEGA TUS CLAVES AQU√ç
    // ==========================================
    const SUPABASE_URL = 'https://hviansyzbyzkfdmgujah.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aWFuc3l6Ynl6a2ZkbWd1amFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMTA0OTAsImV4cCI6MjA4Mjc4NjQ5MH0.1_vn4udmbsQkKRrTMiRFatpfqtRyiq_5VBgdsKjJwW8';
    // ==========================================
    
    let db;
    try { db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error("Error init Supabase:", e); }

    let cart = []; let total = 0; let lastScannedCode = null; let isProcessing = false; let html5QrCode = null; let currentQty = 1; let isOnline = navigator.onLine; let currentUser = null; 
    let editingItemId = null; 
    let currentUnit = 'UN'; // Estado de la unidad actual

    // --- AUTH ---
    if (db) {
        db.auth.onAuthStateChange((event, session) => {
            if (session) handleLoginSuccess(session.user);
            else { document.getElementById('login-screen').style.display = 'flex'; document.getElementById('app-content').style.display = 'none'; }
        });
    }
    async function signInWithGoogle() {
        try {
            const redirectURL = window.location.origin + window.location.pathname;
            const { error } = await db.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: redirectURL } });
            if (error) alert("Error: " + error.message);
        } catch (e) { alert("Error cr√≠tico: " + e.message); }
    }
    async function signOut() { const { error } = await db.auth.signOut(); if (!error) window.location.reload(); }
    function handleLoginSuccess(user) {
        currentUser = user;
        document.getElementById('login-screen').style.display = 'none'; document.getElementById('app-content').style.display = 'block';
        const profileDiv = document.getElementById('user-profile');
        const avatarUrl = user.user_metadata.avatar_url || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
        profileDiv.innerHTML = `<img src="${avatarUrl}" class="user-avatar" onclick="if(confirm('¬øCerrar sesi√≥n?')) signOut()">`;
        showToast(`Hola, ${user.user_metadata.full_name.split(' ')[0]} üëã`);
    }

    // --- CORE LOGIC ---
    const CATEGORIES = { 'frutas': 'ü•¶ Frutas y Verduras', 'carnes': 'ü•© Carnes y Pescados', 'lacteos': 'üßÄ L√°cteos y Huevos', 'panaderia': 'üçû Panader√≠a', 'despensa': 'ü•´ Despensa', 'bebidas': 'ü•§ Bebidas', 'alcohol': 'üç∑ Cervezas y Licores', 'snack': 'üç™ Snacks', 'aseo': 'üßπ Aseo', 'personal': 'üß¥ Personal', 'mascotas': 'üê∂ Mascotas', 'hogar': 'üè† Hogar', 'otros': 'üì¶ Otros' };
    const CAT_ORDER = ["frutas", "carnes", "lacteos", "panaderia", "despensa", "bebidas", "alcohol", "snack", "aseo", "personal", "mascotas", "hogar", "otros"];
    const CACHE_KEY = 'scanner_pro_products'; const QUEUE_KEY = 'scanner_pro_queue'; const CART_KEY = 'scanner_pro_cart_session';

    function loadCartFromLocal() { const savedCart = localStorage.getItem(CART_KEY); if (savedCart) { cart = JSON.parse(savedCart); renderCart(); } }
    loadCartFromLocal();

    window.addEventListener('online', () => { isOnline = true; updateConnectionStatus(); syncOfflineData(); showToast("Conexi√≥n restaurada üåê", "success"); });
    window.addEventListener('offline', () => { isOnline = false; updateConnectionStatus(); showToast("Modo Offline activado üì°", "normal"); });
    updateConnectionStatus();

    function updateConnectionStatus() {
        const badge = document.getElementById('connection-status');
        if(isOnline) { badge.style.display = 'none'; } else { badge.style.display = 'inline-block'; }
        updateSyncUI(); 
    }
    
    function updateSyncUI() {
        const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
        const btn = document.getElementById('sync-btn');
        if (queue.length > 0) { btn.className = 'sync-btn pending'; btn.innerHTML = `‚òÅÔ∏è ${queue.length} Pendientes`; } 
        else { btn.className = 'sync-btn ok'; btn.innerHTML = `‚òÅÔ∏è Al d√≠a`; }
    }
    
    // --- RESET APP FUNCTIONALITY ---
    function resetApp() {
        if(confirm("¬øReparar la aplicaci√≥n?\n\nEsto borrar√° la cola de pendientes y reiniciar√° la app.")) {
            localStorage.removeItem(QUEUE_KEY);
            localStorage.removeItem(CACHE_KEY);
            alert("Aplicaci√≥n reparada. Recargando...");
            window.location.reload();
        }
    }
    
    // --- FORMATO MILES ---
    function handleBudgetInput(input) {
        let value = input.value.replace(/\D/g, ''); 
        if (value === '') { input.value = ''; updateTotalDisplay(); return; }
        input.value = new Intl.NumberFormat('es-CL').format(parseInt(value));
        updateTotalDisplay();
    }

    function formatCurrencyInput(input) {
        let value = input.value.replace(/\D/g, '');
        if (value === '') { input.value = ''; return; }
        input.value = new Intl.NumberFormat('es-CL').format(parseInt(value));
    }

    // --- NUEVO: GESTI√ìN DE UNIDADES ---
    function setUnitType(type) {
        currentUnit = type;
        const btnUn = document.getElementById('btn-unit-un');
        const btnKg = document.getElementById('btn-unit-kg');
        const qtyUn = document.getElementById('qty-controls-un');
        const qtyKg = document.getElementById('qty-controls-kg');
        const priceLabel = document.getElementById('inp-price');

        if (type === 'UN') {
            btnUn.classList.add('active'); btnKg.classList.remove('active');
            qtyUn.style.display = 'flex'; qtyKg.style.display = 'none';
            priceLabel.placeholder = "Precio Unidad ($)";
            currentQty = Math.max(1, Math.round(currentQty)); // Reset a entero
            document.getElementById('qty-display').innerText = currentQty;
        } else {
            btnKg.classList.add('active'); btnUn.classList.remove('active');
            qtyUn.style.display = 'none'; qtyKg.style.display = 'flex';
            priceLabel.placeholder = "Precio por Kilo ($)";
            // Set input value to 0 if not set, or keep current if valid float
            document.getElementById('inp-qty-kg').value = ''; 
        }
    }

    // --- CARGAR COMPARACI√ìN ---
    async function openComparisonModal() {
        const barcode = document.getElementById('modal-barcode').value;
        const currentStore = document.getElementById('store-select').value;
        
        document.getElementById('comparison-modal').style.display = 'block';
        const list = document.getElementById('comparison-list');
        list.innerHTML = '<li>Buscando precios...</li>';
        
        const currentPriceInput = document.getElementById('inp-price').value.replace(/\./g, '');
        const currentPrice = parseInt(currentPriceInput) || 0;

        const { data: others, error } = await db.from('products')
            .select('store, price, updated_at')
            .eq('barcode', barcode)
            .neq('store', currentStore)
            .order('price', { ascending: true });

        if (error || !others || others.length === 0) {
            list.innerHTML = '<li style="padding:15px; text-align:center; color:#999;">No hay precios en otros comercios.</li>';
            return;
        }

        list.innerHTML = '';
        others.forEach(o => {
            const date = new Date(o.updated_at).toLocaleDateString();
            let badgeClass = 'pending'; let badgeText = 'Igual'; let icon = '‚ûñ';
            
            if (currentPrice > 0) {
                if (o.price < currentPrice) { badgeClass = 'cheaper'; badgeText = 'M√°s Barato'; icon = 'üìâ'; } 
                else if (o.price > currentPrice) { badgeClass = 'expensive'; badgeText = 'M√°s Caro'; icon = 'üìà'; }
            }

            const li = document.createElement('li'); li.className = 'product-item';
            li.innerHTML = `<div style="width:100%"><div style="display:flex; justify-content:space-between; align-items:center;"><strong>$${new Intl.NumberFormat('es-CL').format(o.price)}</strong><span class="comp-badge ${badgeClass}">${icon} ${badgeText}</span></div><span style="font-size:0.8rem; color:#666;">en ${o.store.toUpperCase()}</span><br><small style="color:#999">Actualizado: ${date}</small></div>`;
            list.appendChild(li);
        });
    }

    function getLocalCache() { return JSON.parse(localStorage.getItem(CACHE_KEY) || '{}'); }
    function saveToLocalCache(product) { const cache = getLocalCache(); const key = `${product.barcode}_${product.store}`; cache[key] = product; localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); }
    function addToSyncQueue(product) { const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); queue.push(product); localStorage.setItem(QUEUE_KEY, JSON.stringify(queue)); updateSyncUI(); }
    
    async function syncOfflineData() {
        const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); if (queue.length === 0) { showToast("Nada que sincronizar"); return; }
        showToast(`Sincronizando ${queue.length} cambios...`); const remainingQueue = [];
        for (const item of queue) { 
            const { error } = await db.from('price_reports').insert(item); 
            if (error) { console.error("Error Sync:", error); if (error.code) showToast("Error: " + error.message, "alert"); remainingQueue.push(item); }
        }
        localStorage.setItem(QUEUE_KEY, JSON.stringify(remainingQueue)); updateSyncUI();
        if (remainingQueue.length === 0) showToast("Sincronizaci√≥n completa ‚úÖ", "success"); else showToast(`${remainingQueue.length} items fallaron`, "alert");
    }

    async function onScanSuccess(decodedText) { if (isProcessing || decodedText === lastScannedCode) return; isProcessing = true; lastScannedCode = decodedText; stopScanner(); checkProductInDB(decodedText, false); }

    async function checkProductInDB(code, isManualCreation) {
        const currentStore = document.getElementById('store-select').value;
        if(!isManualCreation) showToast(`üîç Buscando...`);
        let product = null;
        if (isOnline) { try { let { data } = await db.from('products').select('*').eq('barcode', code).eq('store', currentStore).single(); product = data; if(product) saveToLocalCache(product); } catch (err) {} }
        if (!product) { const cache = getLocalCache(); product = cache[`${code}_${currentStore}`]; }
        
        // Pasamos unit_type si existe, sino 'UN'
        if (product) openProductModal(code, product.name, product.price, currentStore, false, product.category, 1, product.unit_type || 'UN'); 
        else { 
            let suggestedName = ""; let suggestedCat = "otros"; let suggestedUnit = 'UN';
            if (isOnline) { 
                let { data: other } = await db.from('products').select('name, category, unit_type').eq('barcode', code).limit(1).maybeSingle(); 
                if(other) { suggestedName = other.name; if(other.category) suggestedCat = other.category; if(other.unit_type) suggestedUnit = other.unit_type; } 
            }
            openProductModal(code, suggestedName, "", currentStore, isManualCreation, suggestedCat, 1, suggestedUnit); 
        }
    }

    function adjustQty(delta) { currentQty += delta; if(currentQty < 1) currentQty = 1; document.getElementById('qty-display').innerText = currentQty; }

    async function checkCrossStorePrice(code, currentStore, currentPrice) {
        if (!isOnline) return;
        const alertBox = document.getElementById('comparison-alert'); alertBox.style.display = 'none'; alertBox.className = 'price-alert';
        const { data: bestOption } = await db.from('products').select('store, price').eq('barcode', code).neq('store', currentStore).order('price', { ascending: true }).limit(1).maybeSingle();
        if (bestOption) {
            if (currentPrice && bestOption.price < currentPrice) {
                const diff = currentPrice - bestOption.price;
                alertBox.innerHTML = `‚ö†Ô∏è <b>¬°M√°s barato en ${bestOption.store.toUpperCase()}!</b><br>All√° cuesta $${bestOption.price}. Ahorras $${diff}.`; alertBox.classList.add('cheaper'); alertBox.style.display = 'block';
            } else if (!currentPrice) {
                alertBox.innerHTML = `‚ÑπÔ∏è <b>Referencia:</b><br>Mejor precio: $${bestOption.price} en ${bestOption.store.toUpperCase()}.`; alertBox.classList.add('info'); alertBox.style.display = 'block';
            }
        }
    }

    async function openHistoryModal() {
        const barcode = document.getElementById('modal-barcode').value; if(!barcode) return;
        const currentStore = document.getElementById('store-select').value;
        document.getElementById('history-modal').style.display = 'block';
        const list = document.getElementById('history-list'); list.innerHTML = '<li>Cargando historial...</li>';
        
        const { data, error } = await db.from('price_reports').select('*').eq('barcode', barcode).eq('store', currentStore).neq('status', 'rejected').order('created_at', { ascending: false }).limit(30);
        if(error || !data || data.length === 0) { list.innerHTML = '<li style="padding:15px; text-align:center;">No hay historial v√°lido.</li>'; return; }
        
        list.innerHTML = '';
        let lastShownPrice = -1; let lastShownStore = ''; let shownCount = 0;

        data.forEach(item => {
            if (item.price === lastShownPrice) return;
            lastShownPrice = item.price; shownCount++;
            const date = new Date(item.created_at).toLocaleDateString();
            
            // Tendencia Simple
            let trend = '‚ûñ'; let color = '#666';
            // (L√≥gica simplificada, ideal comparar con item+1)
            
            const li = document.createElement('li'); li.className = 'product-item';
            li.innerHTML = `<div style="width:100%"><div style="display:flex; justify-content:space-between; align-items:center;"><strong style="font-size:1.1rem;">$${new Intl.NumberFormat('es-CL').format(item.price)}</strong></div><small style="color:#999">Registrado el ${date}</small></div>`;
            list.appendChild(li);
        });
        if (shownCount === 0) list.innerHTML = '<li style="padding:15px; text-align:center;">Historial redundante ocultado.</li>';
    }

    function openProductModal(code, name, price, store, isEditableBarcode, category = 'otros', initialQty = 1, unitType = 'UN') {
        currentQty = initialQty; 
        document.getElementById('qty-display').innerText = currentQty;
        document.getElementById('overlay-bg').style.display = 'block'; 
        document.getElementById('product-modal').style.display = 'block';
        
        // CORRECCI√ìN: NO INTENTAR LIMPIAR 'comparison-results' YA QUE NO EXISTE AQU√ç
        
        const barcodeInput = document.getElementById('modal-barcode'); 
        barcodeInput.value = code; 
        barcodeInput.disabled = !isEditableBarcode;
        barcodeInput.style.border = isEditableBarcode ? "1px solid #2e7d32" : "1px dashed #ccc"; 
        barcodeInput.style.backgroundColor = isEditableBarcode ? "#fff" : "#f9f9f9";
        
        document.getElementById('inp-name').value = name; 
        document.getElementById('inp-price').value = price ? new Intl.NumberFormat('es-CL').format(price) : '';
        document.getElementById('inp-category').value = category || 'otros'; 
        document.getElementById('store-badge').innerText = store.toUpperCase();
        
        // SETEAR UNIDAD
        setUnitType(unitType);

        // Si es KG, poner la cantidad en el input
        if (unitType === 'KG') {
            document.getElementById('inp-qty-kg').value = initialQty !== 1 ? initialQty : '';
        }
        
        checkCrossStorePrice(code, store, price);

        if(price) document.querySelector('.btn-confirm').focus(); 
        else if(name) document.getElementById('inp-price').focus(); 
        else document.getElementById('inp-name').focus();
    }

    function closeAllModals() {
        document.getElementById('overlay-bg').style.display = 'none'; 
        document.getElementById('product-modal').style.display = 'none'; 
        document.getElementById('search-modal').style.display = 'none'; 
        document.getElementById('comparison-alert').style.display = 'none'; 
        document.getElementById('history-modal').style.display = 'none'; 
        document.getElementById('comparison-modal').style.display = 'none'; 
        isProcessing = false; lastScannedCode = null; editingItemId = null; 
    }

    function editCartItem(id) {
        const item = cart.find(i => i.id === id); if (!item) return;
        if (!item.barcode || !item.store) { alert("Este producto es antiguo y no se puede editar. B√≥rralo y escanealo de nuevo."); return; }
        editingItemId = id; 
        openProductModal(item.barcode, item.name, item.price, document.getElementById('store-select').value, false, item.category, item.qty, item.unit_type || 'UN');
    }

    async function saveAndAdd() {
        const name = document.getElementById('inp-name').value;
        const rawPrice = document.getElementById('inp-price').value.replace(/\./g, '');
        const price = parseInt(rawPrice);
        const store = document.getElementById('store-select').value;
        const category = document.getElementById('inp-category').value;
        const finalBarcode = document.getElementById('modal-barcode').value.trim();
        
        // OBTENER CANTIDAD CORRECTA
        let finalQty = currentQty;
        if (currentUnit === 'KG') {
            const val = parseFloat(document.getElementById('inp-qty-kg').value);
            if (isNaN(val) || val <= 0) { showToast("‚ö†Ô∏è Ingresa el peso en Kg", "alert"); return; }
            finalQty = val;
        }

        if (!name || isNaN(price) || !finalBarcode) { showToast("‚ö†Ô∏è Faltan datos", "alert"); return; }
        
        const productData = { 
            barcode: finalBarcode, store: store, name: name, price: price, category: category,
            unit_type: currentUnit, // NUEVO CAMPO
            user_id: currentUser ? currentUser.id : null 
        };

        saveToLocalCache(productData);

        if (isOnline) {
            const { error } = await db.from('price_reports').insert(productData);
            if (!error) { finalizeSave(productData, finalQty); } 
            else { console.error("Error insert:", error); showToast(`Error Nube: ${error.message || error.code}`, "alert"); addToSyncQueue(productData); finalizeSave(productData, finalQty, true); }
        } else { addToSyncQueue(productData); finalizeSave(productData, finalQty, true); }
    }

    function finalizeSave(product, qty, offlineMode = false) { 
        addToCart(product, qty); 
        if (editingItemId) { removeFromCart(editingItemId, false); editingItemId = null; }
        if (offlineMode && isOnline) { } else { const msg = offlineMode ? "Guardado en local üì°" : "Guardado exitoso ‚úÖ"; showToast(msg, offlineMode ? "normal" : "success"); }
        closeAllModals(); 
    }
    
    function addToCart(product, qty) { 
        const cartItem = { 
            id: Date.now() + Math.random(), 
            name: product.name, 
            price: product.price, 
            category: product.category || 'otros', 
            unit_type: product.unit_type || 'UN', // Guardar tipo en carrito
            qty: qty, 
            // C√ÅLCULO DE SUBTOTAL: Si es KG, es Precio * Peso. Si es UN, es Precio * Cantidad
            subtotal: Math.round(product.price * qty),
            barcode: product.barcode,
            store: product.store
        }; 
        cart.push(cartItem); 
        saveCartToLocal(); 
        renderCart(); 
    }
    
    function removeFromCart(id, confirmDelete = true) { 
        if(confirmDelete) { if(navigator.vibrate) navigator.vibrate(50); if(!confirm("¬øBorrar item?")) return; }
        cart = cart.filter(item => item.id !== id); saveCartToLocal(); renderCart(); 
    }
    
    function clearCart() { if(cart.length === 0) return; if(confirm("¬øVaciar carrito?")) { cart = []; saveCartToLocal(); renderCart(); showToast("Carrito vaciado"); } }
    function saveCartToLocal() { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

    function renderCart() {
        const list = document.getElementById('cart-list'); list.innerHTML = "";
        let calculatedTotal = 0; const grouped = {};
        cart.forEach(item => { if(!grouped[item.category]) grouped[item.category] = []; grouped[item.category].push(item); calculatedTotal += item.subtotal; });
        const keys = Object.keys(grouped).sort((a,b) => { let ia = CAT_ORDER.indexOf(a); let ib = CAT_ORDER.indexOf(b); if(ia === -1) ia = 99; if(ib === -1) ib = 99; return ia - ib; });
        keys.forEach(cat => {
            const header = document.createElement('li'); header.className = 'category-header'; header.innerText = CATEGORIES[cat] || cat.toUpperCase(); list.appendChild(header);
            grouped[cat].forEach(item => {
                const li = document.createElement('li'); li.className = 'product-item';
                
                // RENDERIZADO DIN√ÅMICO SEG√öN UNIDAD
                let qtyBadge = '';
                let displayPrice = '';
                
                if (item.unit_type === 'KG') {
                    qtyBadge = `<span class="item-qty-badge" style="background:#ef6c00">${item.qty} kg</span>`;
                    displayPrice = `$${item.subtotal.toLocaleString('es-CL')} <small style='color:#999'>($${item.price.toLocaleString('es-CL')}/kg)</small>`;
                } else {
                    qtyBadge = item.qty > 1 ? `<span class="item-qty-badge">${item.qty}x</span>` : '';
                    displayPrice = item.qty > 1 ? `$${item.subtotal.toLocaleString('es-CL')} <small style='color:#999'>($${item.price.toLocaleString('es-CL')} c/u)</small>` : `$${item.price.toLocaleString('es-CL')}`;
                }

                li.innerHTML = `
                    <div style="flex-grow:1; cursor:pointer;" onclick="editCartItem(${item.id})">
                        <span style="font-weight:600; font-size:1rem;">${qtyBadge} ${item.name}</span><br>
                        <span style="color:#666; font-size:0.9rem;">${displayPrice}</span>
                    </div>
                    <button class="btn-delete" onclick="removeFromCart(${item.id})">√ó</button>
                `;
                list.appendChild(li);
            });
        });
        total = calculatedTotal; updateTotalDisplay();
    }

    function updateTotalDisplay() { const amountEl = document.getElementById('total-amount'); const boxEl = document.querySelector('.total-box'); const limitInput = document.getElementById('budget-limit'); const limitValue = limitInput.value.replace(/\./g, ''); amountEl.innerText = '$' + total.toLocaleString('es-CL'); amountEl.className = 'total-price'; boxEl.className = 'total-box'; if (limitValue && parseInt(limitValue) > 0) { const limit = parseInt(limitValue); if (total > limit) { amountEl.classList.add('danger'); boxEl.classList.add('danger'); if(navigator.vibrate) navigator.vibrate([200, 100, 200]); } else if (total > limit * 0.9) { amountEl.classList.add('warning'); } } }
    function handleStoreChange() { if(cart.length > 0 && confirm("¬øCambiaste de tienda? Se limpiar√° el carrito.")) { clearCart(); } }
    function showToast(msg, type="normal") { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show " + type; setTimeout(()=> x.className=x.className.replace("show "+type,""), 3000); }
    
    // --- FUNCI√ìN DE B√öSQUEDA MANUAL ACTUALIZADA (CLEAN ON OPEN) ---
    function openSearchModal() { 
        document.getElementById('overlay-bg').style.display = 'block'; 
        document.getElementById('search-modal').style.display = 'block'; 
        
        // RESET INPUTS Y RESULTADOS
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
        document.getElementById('btn-create-manual').style.display = 'none';
        
        document.getElementById('search-input').focus(); 
    }

    function createManualItem() { const text = document.getElementById('search-input').value; if(!text) return; closeAllModals(); const currentStore = document.getElementById('store-select').value; const isNumeric = /^\d+$/.test(text); const code = isNumeric ? text : 'MAN-' + Date.now(); const name = isNumeric ? "" : text; openProductModal(code, name, "", currentStore, true); }
    let debounceTimer;
    function handleSearchTyping(text) { const btn = document.getElementById('btn-create-manual'); btn.style.display = text.length > 0 ? 'block' : 'none'; if(text.length > 0) btn.innerText = /^\d+$/.test(text) ? `‚ûï Registrar: ${text}` : `‚ûï Crear: "${text}"`; clearTimeout(debounceTimer); debounceTimer = setTimeout(() => searchInDB(text), 300); }
    
    // --- B√öSQUEDA AGRUPADA (NUEVO) ---
    async function searchInDB(text) {
        if(text.length < 2) return;
        const currentStore = document.getElementById('store-select').value;
        let results = [];

        if (!isOnline) {
             const cache = getLocalCache();
             results = Object.values(cache).filter(p => p.name.toLowerCase().includes(text.toLowerCase()) || p.barcode.startsWith(text));
        } else {
            let query = db.from('products').select('*').limit(15);
            if (/^\d+$/.test(text)) query = query.ilike('barcode', `${text}%`); else query = query.ilike('name', `%${text}%`);
            const { data, error } = await query;
            if(error) console.error(error);
            results = data || [];
        }

        const localResults = results.filter(p => p.store === currentStore);
        const externalResults = results.filter(p => p.store !== currentStore);
        renderGroupedSearchResults(localResults, externalResults, currentStore);
    }

    function renderGroupedSearchResults(local, external, currentStore) {
        const list = document.getElementById('search-results'); list.innerHTML = ''; 
        if(local.length === 0 && external.length === 0) { list.innerHTML = '<li style="padding:10px;color:#666">Sin resultados</li>'; return; }

        if (local.length > 0) {
            const header = document.createElement('li');
            header.style.cssText = "background:#e8f5e9; color:#2e7d32; padding:5px 10px; font-size:0.8rem; font-weight:bold; border-bottom:1px solid #c8e6c9;";
            header.innerText = "üìç En este supermercado"; list.appendChild(header);
            local.forEach(p => {
                const li = createSearchResultItem(p, true);
                li.onclick = function() { // Usamos function para asegurar el scope del try catch
                    try {
                        closeAllModals(); 
                        // Seguridad contra Nulos
                        const safePrice = p.price || 0;
                        const safeCategory = p.category || 'otros';
                        openProductModal(p.barcode, p.name, safePrice, p.store, false, safeCategory, 1, p.unit_type || 'UN'); 
                    } catch(err) {
                        alert("Error al abrir: " + err.message);
                    }
                };
                list.appendChild(li);
            });
        }

        if (external.length > 0) {
            const header = document.createElement('li');
            header.style.cssText = "background:#f5f5f5; color:#666; padding:5px 10px; font-size:0.8rem; font-weight:bold; border-bottom:1px solid #ddd; margin-top:5px;";
            header.innerText = "üåç En otros comercios (Importar)"; list.appendChild(header);
            external.forEach(p => {
                const li = createSearchResultItem(p, false);
                li.onclick = function() {
                    try {
                        closeAllModals(); 
                        const safeCategory = p.category || 'otros';
                        openProductModal(p.barcode, p.name, '', currentStore, false, safeCategory, 1, p.unit_type || 'UN'); 
                        showToast(`Datos importados de ${p.store.toUpperCase()}`);
                    } catch(err) {
                        alert("Error al importar: " + err.message);
                    }
                };
                list.appendChild(li);
            });
        }
    }

    function createSearchResultItem(p, isLocal) {
        const li = document.createElement('li'); li.className = 'search-result-item';
        if(!isLocal) li.style.opacity = '0.9';
        const storeBadge = isLocal ? `<span style="background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:4px; font-weight:bold; font-size:0.75rem;">AQU√ç</span>` : `<span style="background:#eee; color:#666; padding:2px 6px; border-radius:4px; font-weight:bold; font-size:0.75rem;">${p.store.toUpperCase()}</span>`;
        // Seguridad contra precio Nulo
        const priceDisplay = p.price ? new Intl.NumberFormat('es-CL').format(p.price) : '???';
        li.innerHTML = `<div style="flex-grow:1; margin-right:10px;"><span style="font-weight:600; display:block; line-height:1.2;">${p.name}</span><small style="color:#666; display:flex; align-items:center; gap:5px; margin-top:2px;">${storeBadge}<span>${p.barcode}</span></small></div><b style="font-size:1.1rem; color:#333;">$${priceDisplay}</b>`;
        return li;
    }

    function startScanner() { document.getElementById('scanner-container').style.display = 'block'; html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 }, formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8 ] }, onScanSuccess).catch(err => html5QrCode.start({ facingMode: "user" }, { fps: 10, qrbox: 250 }, onScanSuccess)); }
    function stopScanner() { if(html5QrCode) html5QrCode.stop().then(() => { document.getElementById('scanner-container').style.display = 'none'; html5QrCode.clear(); }).catch(e=>console.error(e)); else document.getElementById('scanner-container').style.display = 'none'; }
</script>

</body>
</html>
