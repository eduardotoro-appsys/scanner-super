<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Supermercado Real</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; }
        header { background-color: #2e7d32; color: white; padding: 15px; text-align: center; }
        #scanner-container { width: 100%; max-width: 500px; margin: 0 auto; background: black; }
        .dashboard { padding: 15px; max-width: 500px; margin: 0 auto; }
        .total-box { background-color: #fff; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .total-price { font-size: 2rem; font-weight: bold; color: #2e7d32; }
        .product-item { background: white; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; }
        button { padding: 10px 20px; background-color: #2e7d32; color: white; border: none; border-radius: 5px; width: 100%; margin-top: 10px;}
    </style>
</head>
<body>

<header><h1>üõí Scanner Cloud</h1></header>

<div id="scanner-container">
    <div id="reader" style="width: 100%;"></div>
</div>

<div class="dashboard">
    <button id="start-btn" onclick="startScanner()">üì∑ Iniciar C√°mara</button>
    <div id="status" style="text-align: center; margin: 10px; color: #666;">Listo para escanear...</div>

    <div class="total-box">
        <div>Total Estimado</div>
        <div class="total-price" id="total-amount">$0</div>
    </div>
    <ul id="cart-list" style="list-style: none; padding: 0;"></ul>
</div>

<script>
    // --------------------------------------------------
    // 1. PEGA TUS CLAVES AQU√ç DENTRO DE LAS COMILLAS ''
    // --------------------------------------------------
    const SUPABASE_URL = 'https://hviansyzbyzkfdmgujah.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_sfFASSOkI15dXpf5vulSRQ_f5EZTW4_';
    // --------------------------------------------------

    // Inicializamos la conexi√≥n (Usamos 'db' para evitar conflictos)
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let total = 0;
    let lastScannedCode = null;
    let isProcessing = false;

    // Funci√≥n para manejar el √©xito del escaneo
    async function onScanSuccess(decodedText, decodedResult) {
        if (isProcessing || decodedText === lastScannedCode) return;
        
        isProcessing = true;
        lastScannedCode = decodedText;
        document.getElementById('status').innerText = "üîç Buscando precio...";

        try {
            // Buscamos en la tabla 'products' usando la conexi√≥n 'db'
            let { data: product, error } = await db
                .from('products')
                .select('*')
                .eq('barcode', decodedText)
                .single(); // .single() nos da un objeto directo, no una lista

            if (product) {
                // --- ESCENARIO: PRODUCTO EXISTE ---
                addToCart(product.name, product.price);
                alert(`‚úÖ Encontrado: ${product.name}`);
            } else {
                // --- ESCENARIO: PRODUCTO NUEVO ---
                // El producto no est√° en la base de datos
                let priceInput = prompt(`üÜï Producto Nuevo detectado (${decodedText}).\nIngrese el PRECIO:`);
                
                if (priceInput) {
                    let nameInput = prompt("Ingrese el NOMBRE del producto:");
                    let price = parseInt(priceInput);
                    
                    if (nameInput && !isNaN(price)) {
                        // Guardamos en Supabase
                        const { error: insertError } = await db
                            .from('products')
                            .insert([{ barcode: decodedText, name: nameInput, price: price }]);
                        
                        if (insertError) {
                            alert("Error al guardar: " + insertError.message);
                        } else {
                            addToCart(nameInput, price);
                            alert("¬°Producto guardado para el futuro!");
                        }
                    }
                }
            }
        } catch (err) {
            console.error(err);
            alert("Ocurri√≥ un error inesperado: " + err.message);
        }

        // Esperar 2 segundos antes de permitir otro escaneo
        setTimeout(() => { 
            isProcessing = false; 
            lastScannedCode = null; 
            document.getElementById('status').innerText = "Listo para escanear..."; 
        }, 2000);
    }

    // Funci√≥n MEJORADA: Agrega bot√≥n de borrar
    function addToCart(name, price) {
        // 1. Sumar al total
        total += price;
        updateTotalDisplay();
        
        // 2. Crear el elemento visual
        const ul = document.getElementById('cart-list');
        const li = document.createElement('li');
        li.className = 'product-item';
        
        // Agregamos un ID √∫nico temporal para poder identificar este item si quisi√©ramos
        li.innerHTML = `
            <div style="flex-grow: 1;">
                <span>${name}</span><br>
                <small style="color: #666;">$${price}</small>
            </div>
            <button onclick="removeFromCart(this, ${price})" style="width: auto; padding: 5px 10px; background: #e53935; margin: 0; margin-left: 10px;">
                üóëÔ∏è
            </button>
        `;
        
        // Insertar al principio de la lista
        ul.insertBefore(li, ul.firstChild);
    }

    // NUEVA FUNCI√ìN: Restar y borrar visualmente
    function removeFromCart(buttonElement, price) {
        if(!confirm("¬øBorrar este producto del carrito?")) return;

        // 1. Restar del total
        total -= price;
        if (total < 0) total = 0; // Seguridad para que no de negativo
        updateTotalDisplay();

        // 2. Eliminar la l√≠nea visual (el padre del bot√≥n es el <li>)
        const li = buttonElement.parentElement;
        li.remove();
    }

    // Funci√≥n auxiliar para actualizar el texto del precio
    function updateTotalDisplay() {
        document.getElementById('total-amount').innerText = '$' + total.toLocaleString();
    }

    function startScanner() {
        // Agregamos un try-catch para avisarte si falla la c√°mara
        try {
            document.getElementById('status').innerText = "Iniciando c√°mara...";
            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 }, 
                onScanSuccess
            ).catch(err => {
                alert("Error al abrir c√°mara: " + err);
            });
            
            document.getElementById('start-btn').style.display = 'none';
        } catch (e) {
            alert("Error cr√≠tico al iniciar: " + e.message);
        }
    }
</script>

</body>
</html>
