<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Precios Pro V11</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; }
        
        header { 
            background-color: #2e7d32; padding: 10px; display: flex; flex-direction: column; 
            align-items: center; position: sticky; top: 0; z-index: 10; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
        }
        h1 { margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.9); margin-bottom: 5px; font-weight: normal; }
        
        #store-select {
            font-size: 1.1rem; padding: 8px 12px; border-radius: 8px; border: none; 
            font-weight: bold; width: 95%; max-width: 300px; text-align: center;
            background: white; color: #2e7d32; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #scanner-container { width: 100%; background: black; min-height: 250px; position: relative; overflow: hidden; display: none; }
        #reader video { width: 100%; height: auto; object-fit: contain !important; }
        
        .dashboard { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        
        /* BOTONES PRINCIPALES */
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-main { 
            flex: 1; padding: 15px; background-color: #2e7d32; color: white; 
            border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; 
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary {
            flex: 1; padding: 15px; background-color: #1976d2; color: white;
            border: none; border-radius: 8px; font-size: 1rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        /* CAJA TOTAL */
        .total-box { 
            background: white; padding: 20px; border-radius: 12px; text-align: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; border: 2px solid transparent;
            transition: all 0.3s ease; position: relative;
        }
        .total-price { font-size: 2.5rem; font-weight: 800; color: #2e7d32; margin-top: 5px; transition: color 0.3s; }
        
        .total-price.warning { color: #f57c00; }
        .total-price.danger { color: #d32f2f; animation: pulse 1s infinite; }
        .total-box.danger { border-color: #d32f2f; background-color: #ffebee; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Control de Presupuesto */
        .budget-control { 
            margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee;
            display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; color: #555;
        }
        .budget-input {
            width: 80px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; 
            text-align: center; font-size: 1rem; color: #333; margin-bottom: 0; font-weight: bold;
        }

        /* Bot√≥n Vaciar Carrito */
        .btn-clear-cart {
            margin-top: 15px; background: none; border: 1px solid #ffcdd2; color: #c62828;
            padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;
        }

        /* LISTA PRODUCTOS */
        .product-list { list-style: none; padding: 0; }
        .product-item { 
            background: white; border-bottom: 1px solid #f0f0f0; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            animation: fadeIn 0.3s ease;
        }
        .item-qty-badge {
            background: #2e7d32; color: white; padding: 2px 6px; border-radius: 4px; 
            font-size: 0.8rem; font-weight: bold; margin-right: 5px;
        }
        .btn-delete { 
            background: #ffcdd2; color: #c62828; border: none; padding: 8px 12px; 
            border-radius: 6px; margin-left: 10px; cursor: pointer; font-size: 1.2rem;
        }

        /* MODAL */
        .modal { 
            display: none; position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; padding: 25px 20px; border-radius: 20px 20px 0 0; 
            z-index: 100; box-shadow: 0 -4px 30px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        input { 
            width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 1.1rem; box-sizing: border-box; margin-bottom: 15px; -webkit-appearance: none;
        }
        #modal-barcode {
            font-family: monospace; font-size: 0.9rem; color: #666; 
            background: #f9f9f9; margin-bottom: 10px; border: 1px dashed #ccc;
        }
        
        /* NUEVO: CONTROL DE CANTIDAD */
        .qty-wrapper {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; background: #f5f5f5; padding: 10px; border-radius: 8px;
        }
        .qty-controls { display: flex; align-items: center; gap: 15px; }
        .btn-qty {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #fff; color: #2e7d32; font-size: 1.5rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        #qty-display { font-size: 1.5rem; font-weight: bold; min-width: 30px; text-align: center; }

        /* NUEVO: ALERTA DE PRECIO (Estilos V10) */
        .price-alert {
            display: none; padding: 12px; margin-bottom: 15px; border-radius: 8px; 
            font-size: 0.9rem; line-height: 1.4; border: 1px solid transparent;
        }
        .price-alert.cheaper { background-color: #fff3e0; color: #e65100; border-color: #ffe0b2; } /* Alerta Naranja */
        .price-alert.info { background-color: #e3f2fd; color: #1565c0; border-color: #bbdefb; } /* Alerta Azul */

        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .btn-confirm { flex: 2; background: #2e7d32; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-cancel { flex: 1; background: #f5f5f5; color: #333; padding: 15px; border: none; border-radius: 8px; font-weight: bold; }

        /* B√∫squeda Manual */
        #search-results { list-style: none; padding: 0; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .search-result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 101; left: 50%; bottom: 30px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-weight: 500; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #overlay-bg { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 90; }
    </style>
</head>
<body>

<header>
    <h1>Est√°s en:</h1>
    <select id="store-select" onchange="handleStoreChange()">
        <option value="lider">üîµ Lider</option>
        <option value="jumbo">üêò Jumbo</option>
        <option value="unimarc">üî¥ Unimarc</option>
        <option value="tottus">üü¢ Tottus</option>
        <option value="acuenta">üõí aCuenta</option>
        <option value="santa_isabel">üêº Santa Isabel</option>
        <option value="mayorista">üì¶ Mayorista</option>
        <option value="otro">üè™ Almac√©n / Otro</option>
    </select>
</header>

<div id="scanner-container">
    <div id="reader"></div>
    <button onclick="stopScanner()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; padding:5px 10px; border-radius:4px;">Cerrar X</button>
</div>

<div class="dashboard">
    <div class="btn-group">
        <button id="start-btn" class="btn-main" onclick="startScanner()">üì∑ Escanear</button>
        <button class="btn-secondary" onclick="openSearchModal()">‚úçÔ∏è Manual</button>
    </div>
    
    <div class="total-box">
        <small>Total Carrito</small>
        <div class="total-price" id="total-amount">$0</div>
        
        <div class="budget-control">
            <span>üéØ Meta: $</span>
            <input type="number" class="budget-input" id="budget-limit" placeholder="..." oninput="updateTotalDisplay()">
        </div>
        
        <button class="btn-clear-cart" onclick="clearCart()">üóëÔ∏è Vaciar Carrito</button>
    </div>

    <ul class="product-list" id="cart-list"></ul>
</div>

<div id="overlay-bg" onclick="closeAllModals()"></div>

<!-- MODAL B√öSQUEDA -->
<div id="search-modal" class="modal">
    <div class="modal-header"><strong>üîç Buscar o Crear</strong></div>
    <input type="text" id="search-input" placeholder="Nombre o C√≥digo..." onkeyup="handleSearchTyping(this.value)">
    <ul id="search-results"></ul>
    <button class="btn-main" id="btn-create-manual" style="display:none; margin-top: 15px; background-color: #1976d2; box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3); width: 100%;" onclick="createManualItem()">‚ûï Crear Nuevo</button>
    <button class="btn-cancel" style="width:100%; margin-top:10px;" onclick="closeAllModals()">Cerrar</button>
</div>

<!-- MODAL PRODUCTO (Con Alerta de Precios V10) -->
<div id="product-modal" class="modal">
    <div class="modal-header">
        <strong>üìù Detalle Producto</strong>
        <span id="store-badge" style="background:#e3f2fd; color:#1565c0; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;"></span>
    </div>
    
    <!-- √ÅREA DE ALERTA DE PRECIOS -->
    <div id="comparison-alert" class="price-alert"></div>
    
    <label style="font-size:0.8rem; color:#666;">C√≥digo:</label>
    <input type="text" id="modal-barcode" disabled>
    
    <input type="text" id="inp-name" placeholder="Nombre (ej: Leche)" autocomplete="off">
    <input type="tel" id="inp-price" placeholder="Precio Unidad ($)" inputmode="numeric">
    
    <div class="qty-wrapper">
        <span style="font-weight:bold; color:#555;">Cantidad:</span>
        <div class="qty-controls">
            <button class="btn-qty" onclick="adjustQty(-1)">‚àí</button>
            <span id="qty-display">1</span>
            <button class="btn-qty" onclick="adjustQty(1)">+</button>
        </div>
    </div>
    
    <div class="modal-btns">
        <button class="btn-cancel" onclick="closeAllModals()">Cancelar</button>
        <button class="btn-confirm" onclick="saveAndAdd()">Guardar</button>
    </div>
</div>

<div id="toast">Mensaje...</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è PEGA TUS CLAVES DE SUPABASE AQU√ç
    // ==========================================
    const SUPABASE_URL = 'https://hviansyzbyzkfdmgujah.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_sfFASSOkI15dXpf5vulSRQ_f5EZTW4_';
    // ==========================================
    
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let total = 0;
    let lastScannedCode = null;
    let isProcessing = false;
    let html5QrCode = null;
    let currentQty = 1; 

    // --- ESCANEO ---
    async function onScanSuccess(decodedText) {
        if (isProcessing || decodedText === lastScannedCode) return;
        isProcessing = true;
        lastScannedCode = decodedText;
        stopScanner();
        checkProductInDB(decodedText, false);
    }

    async function checkProductInDB(code, isManualCreation) {
        const currentStore = document.getElementById('store-select').value;
        if(!isManualCreation) showToast(`üîç Buscando...`);

        try {
            let { data: product } = await db.from('products').select('*').eq('barcode', code).eq('store', currentStore).single();
            
            if (product) {
                openProductModal(code, product.name, product.price, currentStore, false);
            } else {
                let { data: other } = await db.from('products').select('name').eq('barcode', code).limit(1).maybeSingle();
                const suggested = other ? other.name : "";
                openProductModal(code, suggested, "", currentStore, isManualCreation);
            }
        } catch (err) {
            console.error(err);
            showToast("Error de conexi√≥n", "alert");
            isProcessing = false;
        }
    }

    // --- MANEJO DE CANTIDAD ---
    function adjustQty(delta) {
        currentQty += delta;
        if(currentQty < 1) currentQty = 1;
        document.getElementById('qty-display').innerText = currentQty;
    }

    // --- COMPARADOR DE PRECIOS (Inteligencia Cruzada V10) ---
    async function checkCrossStorePrice(code, currentStore, currentPrice) {
        const alertBox = document.getElementById('comparison-alert');
        alertBox.style.display = 'none'; // Reiniciar
        alertBox.className = 'price-alert';

        // Buscar el precio m√°s bajo en OTROS supermercados
        const { data: bestOption } = await db
            .from('products')
            .select('store, price, updated_at')
            .eq('barcode', code)
            .neq('store', currentStore) // Diferente al actual
            .order('price', { ascending: true }) // El m√°s barato primero
            .limit(1)
            .maybeSingle();

        if (bestOption) {
            // Caso 1: Tenemos precio actual y encontramos uno m√°s barato fuera
            if (currentPrice && bestOption.price < currentPrice) {
                const diff = currentPrice - bestOption.price;
                alertBox.innerHTML = `‚ö†Ô∏è <b>¬°Est√° m√°s barato en ${bestOption.store.toUpperCase()}!</b><br>All√° cuesta $${bestOption.price}. Te ahorrar√≠as $${diff} por unidad.`;
                alertBox.classList.add('cheaper');
                alertBox.style.display = 'block';
            }
            // Caso 2: No tenemos precio actual (Producto Nuevo), mostramos referencia
            else if (!currentPrice) {
                alertBox.innerHTML = `‚ÑπÔ∏è <b>Referencia de precio:</b><br>El mejor precio registrado es $${bestOption.price} en ${bestOption.store.toUpperCase()}.`;
                alertBox.classList.add('info');
                alertBox.style.display = 'block';
            }
        }
    }

    // --- MODALES ---
    function openProductModal(code, name, price, store, isEditableBarcode) {
        currentQty = 1;
        document.getElementById('qty-display').innerText = "1";

        document.getElementById('overlay-bg').style.display = 'block';
        document.getElementById('product-modal').style.display = 'block';
        
        // Ejecutar Comparador (As√≠ncrono - No bloquea la UI)
        checkCrossStorePrice(code, store, price);

        const barcodeInput = document.getElementById('modal-barcode');
        barcodeInput.value = code;
        barcodeInput.disabled = !isEditableBarcode;
        barcodeInput.style.border = isEditableBarcode ? "1px solid #2e7d32" : "1px dashed #ccc";
        barcodeInput.style.backgroundColor = isEditableBarcode ? "#fff" : "#f9f9f9";

        document.getElementById('inp-name').value = name;
        document.getElementById('inp-price').value = price;
        document.getElementById('store-badge').innerText = store.toUpperCase();

        if(price) document.querySelector('.btn-confirm').focus();
        else if(name) document.getElementById('inp-price').focus();
        else document.getElementById('inp-name').focus();
    }

    function closeAllModals() {
        document.getElementById('overlay-bg').style.display = 'none';
        document.getElementById('product-modal').style.display = 'none';
        document.getElementById('search-modal').style.display = 'none';
        document.getElementById('comparison-alert').style.display = 'none'; // Limpiar alerta
        isProcessing = false;
        lastScannedCode = null;
    }

    // --- GUARDAR ---
    async function saveAndAdd() {
        const name = document.getElementById('inp-name').value;
        const price = parseInt(document.getElementById('inp-price').value);
        const store = document.getElementById('store-select').value;
        const finalBarcode = document.getElementById('modal-barcode').value.trim();

        if (!name || isNaN(price) || !finalBarcode) { showToast("‚ö†Ô∏è Faltan datos", "alert"); return; }

        const { error } = await db.from('products').upsert({ barcode: finalBarcode, store: store, name: name, price: price });

        if (!error) {
            addToCart(name, price, currentQty);
            const msg = currentQty > 1 ? `‚úÖ Agregados ${currentQty} productos` : `‚úÖ Agregado`;
            showToast(msg, "success");
            closeAllModals();
        } else {
            showToast("Error BD: " + error.message, "alert");
        }
    }

    // --- CARRITO ---
    function addToCart(name, price, qty) {
        const subtotal = price * qty;
        total += subtotal;
        updateTotalDisplay();
        
        const ul = document.getElementById('cart-list');
        const li = document.createElement('li');
        li.className = 'product-item';
        
        const qtyBadge = qty > 1 ? `<span class="item-qty-badge">${qty}x</span>` : '';
        const displayPrice = qty > 1 ? `$${subtotal.toLocaleString()} <small style='color:#999'>($${price} c/u)</small>` : `$${price.toLocaleString()}`;

        li.innerHTML = `
            <div class="item-info">
                <span class="item-name">${qtyBadge} ${name}</span>
                <span class="item-price">${displayPrice}</span>
            </div>
            <button class="btn-delete" onclick="removeFromCart(this, ${subtotal})">√ó</button>
        `;
        ul.insertBefore(li, ul.firstChild);
    }

    function removeFromCart(btn, subtotal) {
        if(navigator.vibrate) navigator.vibrate(50);
        if(!confirm("¬øBorrar item?")) return;
        total -= subtotal; if(total < 0) total = 0;
        updateTotalDisplay();
        btn.parentElement.remove();
    }

    function clearCart() {
        if(total === 0) return;
        if(confirm("¬øEst√°s seguro de vaciar TODO el carrito?")) {
            total = 0; updateTotalDisplay(); document.getElementById('cart-list').innerHTML = ""; showToast("Carrito vaciado");
        }
    }

    function updateTotalDisplay() { 
        const amountEl = document.getElementById('total-amount');
        const boxEl = document.querySelector('.total-box');
        const limitInput = document.getElementById('budget-limit').value;
        
        amountEl.innerText = '$' + total.toLocaleString();
        amountEl.className = 'total-price';
        boxEl.className = 'total-box';
        
        if (limitInput && parseInt(limitInput) > 0) {
            const limit = parseInt(limitInput);
            if (total > limit) {
                amountEl.classList.add('danger'); boxEl.classList.add('danger');
                if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
            } else if (total > limit * 0.9) {
                amountEl.classList.add('warning');
            }
        }
    }

    // --- UTILS Y B√öSQUEDA ---
    function handleStoreChange() { if(total > 0 && confirm("¬øCambiaste de tienda? Se limpiar√° el carrito.")) { clearCart(); } }
    function showToast(msg, type="normal") { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show " + type; setTimeout(()=> x.className=x.className.replace("show "+type,""), 3000); }
    
    // B√∫squeda Manual
    function openSearchModal() { document.getElementById('overlay-bg').style.display = 'block'; document.getElementById('search-modal').style.display = 'block'; document.getElementById('search-input').focus(); }
    function createManualItem() { 
        const text = document.getElementById('search-input').value; if(!text) return; closeAllModals();
        const currentStore = document.getElementById('store-select').value;
        const isNumeric = /^\d+$/.test(text);
        const code = isNumeric ? text : 'MAN-' + Date.now();
        const name = isNumeric ? "" : text;
        openProductModal(code, name, "", currentStore, true);
    }
    let debounceTimer;
    function handleSearchTyping(text) { 
        const btn = document.getElementById('btn-create-manual');
        btn.style.display = text.length > 0 ? 'block' : 'none';
        if(text.length > 0) btn.innerText = /^\d+$/.test(text) ? `‚ûï Registrar: ${text}` : `‚ûï Crear: "${text}"`;
        clearTimeout(debounceTimer); debounceTimer = setTimeout(() => searchInDB(text), 300); 
    }
    
    // --- FUNCI√ìN DE B√öSQUEDA MEJORADA (MUESTRA LA TIENDA) ---
    async function searchInDB(text) {
        if(text.length < 2) return;
        let query = db.from('products').select('*').limit(5);
        if (/^\d+$/.test(text)) query = query.ilike('barcode', `${text}%`); else query = query.ilike('name', `%${text}%`);
        let { data: results } = await query;
        const list = document.getElementById('search-results'); list.innerHTML = '';
        if(results?.length) {
            results.forEach(p => {
                const li = document.createElement('li'); li.className = 'search-result-item';
                // AQU√ç EST√Å EL CAMBIO: Se agrega el supermercado (store) en verde
                li.innerHTML = `
                    <div style="flex-grow:1; margin-right:10px;">
                        <span style="font-weight:600; display:block; line-height:1.2;">${p.name}</span>
                        <small style="color:#666; font-size:0.8rem; display:flex; align-items:center; gap:5px; margin-top:2px;">
                            <span style="background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:4px; font-weight:bold; font-size:0.75rem;">${p.store.toUpperCase()}</span>
                            <span>${p.barcode}</span>
                        </small>
                    </div>
                    <b style="font-size:1.1rem; color:#333;">$${p.price}</b>
                `;
                li.onclick = () => { closeAllModals(); openProductModal(p.barcode, p.name, p.price, p.store, false); };
                list.appendChild(li);
            });
        } else { list.innerHTML = '<li style="padding:10px;color:#666">Sin resultados</li>'; }
    }

    // --- C√ÅMARA ---
    function startScanner() {
        document.getElementById('scanner-container').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 }, formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8 ] }, onScanSuccess)
        .catch(err => html5QrCode.start({ facingMode: "user" }, { fps: 10, qrbox: 250 }, onScanSuccess));
    }
    function stopScanner() { if(html5QrCode) html5QrCode.stop().then(() => { document.getElementById('scanner-container').style.display = 'none'; html5QrCode.clear(); }).catch(e=>console.error(e)); else document.getElementById('scanner-container').style.display = 'none'; }
</script>

</body>
</html>
