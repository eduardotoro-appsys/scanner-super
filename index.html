<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro V17</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; }
        
        /* PANTALLA DE LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            z-index: 2000; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; color: white;
            padding: 20px; box-sizing: border-box; text-align: center;
        }
        .login-logo { font-size: 4rem; margin-bottom: 20px; }
        .login-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .login-desc { font-size: 1rem; opacity: 0.9; margin-bottom: 40px; max-width: 300px; }
        
        .btn-google {
            background: white; color: #333; border: none; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; font-size: 1rem;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .btn-google:active { transform: scale(0.95); }
        .btn-google img { width: 20px; height: 20px; }

        /* HEADER APP */
        header { 
            background-color: #2e7d32; padding: 8px 15px 12px 15px; 
            display: flex; flex-direction: column; align-items: center; 
            position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: background-color 0.3s;
        }
        header.offline { background-color: #455a64; }

        /* PERFIL USUARIO */
        .user-profile {
            position: absolute; top: 10px; right: 15px;
            display: flex; align-items: center; gap: 8px;
        }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; }
        .btn-logout { 
            background: rgba(0,0,0,0.3); color: white; border: none; 
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;
        }

        #connection-status {
            font-size: 0.7rem; color: white; background: rgba(0,0,0,0.2); 
            padding: 2px 8px; border-radius: 10px; margin-bottom: 4px; display: none;
        }
        
        #store-select {
            font-size: 0.9rem; padding: 4px 12px; border-radius: 20px; border: none; 
            font-weight: 600; width: auto; min-width: 150px; max-width: 80%;
            text-align: center; text-align-last: center;
            background: rgba(255,255,255,0.9); color: #1b5e20; outline: none; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); margin-bottom: 8px; 
            -webkit-appearance: none; appearance: none;
        }

        .header-controls { display: flex; gap: 8px; width: 100%; max-width: 400px; }
        .btn-main, .btn-secondary {
            flex: 1; padding: 10px; border: none; border-radius: 8px; 
            font-size: 0.9rem; font-weight: bold; cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; 
            align-items: center; justify-content: center; gap: 6px;
        }
        .btn-main { background-color: white; color: #2e7d32; }
        .btn-secondary { background-color: rgba(255,255,255,0.25); color: white; }

        /* CONTENIDO PRINCIPAL (Oculto hasta login) */
        #app-content { display: none; }

        #scanner-container { width: 100%; background: black; min-height: 250px; position: relative; overflow: hidden; display: none; }
        #reader video { width: 100%; height: auto; object-fit: contain !important; }
        
        .dashboard { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        
        .total-box { 
            background: white; padding: 20px; border-radius: 12px; text-align: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; border: 2px solid transparent;
            transition: all 0.3s ease; position: relative; margin-top: 5px; 
        }
        .total-price { font-size: 2.5rem; font-weight: 800; color: #2e7d32; margin-top: 5px; transition: color 0.3s; }
        .total-price.warning { color: #f57c00; }
        .total-price.danger { color: #d32f2f; animation: pulse 1s infinite; }
        .total-box.danger { border-color: #d32f2f; background-color: #ffebee; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .budget-control { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #eee; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; color: #555; }
        .budget-input { width: 80px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 1rem; color: #333; margin-bottom: 0; font-weight: bold; }
        .btn-clear-cart { margin-top: 15px; background: none; border: 1px solid #ffcdd2; color: #c62828; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; }

        .product-list { list-style: none; padding: 0; }
        .category-header { background: #e8f5e9; color: #2e7d32; padding: 8px 12px; border-radius: 6px; font-weight: bold; margin-top: 15px; margin-bottom: 5px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
        .product-item { background: white; border-bottom: 1px solid #f0f0f0; padding: 15px; display: flex; justify-content: space-between; align-items: center; animation: fadeIn 0.3s ease; }
        .item-qty-badge { background: #2e7d32; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-right: 5px; }
        .btn-delete { background: #ffcdd2; color: #c62828; border: none; padding: 8px 12px; border-radius: 6px; margin-left: 10px; cursor: pointer; font-size: 1.2rem; }

        .modal { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 25px 20px; border-radius: 20px 20px 0 0; z-index: 101; box-shadow: 0 -4px 30px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        input, select { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 1.1rem; box-sizing: border-box; margin-bottom: 15px; -webkit-appearance: none; }
        select { background-color: white; }
        #modal-barcode { font-family: monospace; font-size: 0.9rem; color: #666; background: #f9f9f9; margin-bottom: 10px; border: 1px dashed #ccc; }
        
        .qty-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: #f5f5f5; padding: 10px; border-radius: 8px; }
        .qty-controls { display: flex; align-items: center; gap: 15px; }
        .btn-qty { width: 40px; height: 40px; border-radius: 50%; border: none; background: #fff; color: #2e7d32; font-size: 1.5rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #qty-display { font-size: 1.5rem; font-weight: bold; min-width: 30px; text-align: center; }

        .price-alert { display: none; padding: 12px; margin-bottom: 15px; border-radius: 8px; font-size: 0.9rem; line-height: 1.4; border: 1px solid transparent; }
        .price-alert.cheaper { background-color: #fff3e0; color: #e65100; border-color: #ffe0b2; }
        .price-alert.info { background-color: #e3f2fd; color: #1565c0; border-color: #bbdefb; }

        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .btn-confirm { flex: 2; background: #2e7d32; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-cancel { flex: 1; background: #f5f5f5; color: #333; padding: 15px; border: none; border-radius: 8px; font-weight: bold; }

        #search-results { list-style: none; padding: 0; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .search-result-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 200; left: 50%; bottom: 30px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-weight: 500; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #overlay-bg { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 100; }
    </style>
</head>
<body>

<!-- PANTALLA DE LOGIN -->
<div id="login-screen">
    <div class="login-logo">üõí</div>
    <div class="login-title">Scanner Pro</div>
    <div class="login-desc">Tu asistente inteligente para compras de supermercado.</div>
    
    <button class="btn-google" onclick="signInWithGoogle()">
        <img src="https://cdn-icons-png.flaticon.com/512/300/300221.png" alt="G">
        Ingresar con Google
    </button>
</div>

<!-- APP PRINCIPAL (Oculta por defecto) -->
<div id="app-content">
    <header id="app-header">
        <div id="connection-status">üì° Modo Offline</div>
        
        <!-- PERFIL USUARIO -->
        <div class="user-profile" id="user-profile">
            <!-- Se llena con JS -->
        </div>

        <select id="store-select" onchange="handleStoreChange()">
            <option value="lider">üîµ Lider</option>
            <option value="jumbo">üêò Jumbo</option>
            <option value="unimarc">üî¥ Unimarc</option>
            <option value="tottus">üü¢ Tottus</option>
            <option value="acuenta">üõí aCuenta</option>
            <option value="santa_isabel">üêº Santa Isabel</option>
            <option value="mayorista">üì¶ Mayorista</option>
            <option value="otro">üè™ Almac√©n / Otro</option>
        </select>
        
        <div class="header-controls">
            <button id="start-btn" class="btn-main" onclick="startScanner()">üì∑ Escanear</button>
            <button class="btn-secondary" onclick="openSearchModal()">‚úçÔ∏è Manual</button>
        </div>
    </header>

    <div id="scanner-container">
        <div id="reader"></div>
        <button onclick="stopScanner()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; padding:5px 10px; border-radius:4px;">Cerrar X</button>
    </div>

    <div class="dashboard">
        <div class="total-box">
            <small>Total Carrito</small>
            <div class="total-price" id="total-amount">$0</div>
            <div class="budget-control">
                <span>üéØ Meta: $</span>
                <input type="number" class="budget-input" id="budget-limit" placeholder="..." oninput="updateTotalDisplay()">
            </div>
            <button class="btn-clear-cart" onclick="clearCart()">üóëÔ∏è Vaciar Carrito</button>
        </div>

        <ul class="product-list" id="cart-list"></ul>
    </div>
</div>

<div id="overlay-bg" onclick="closeAllModals()"></div>

<!-- MODAL B√öSQUEDA -->
<div id="search-modal" class="modal">
    <div class="modal-header"><strong>üîç Buscar o Crear</strong></div>
    <input type="text" id="search-input" placeholder="Nombre o C√≥digo..." onkeyup="handleSearchTyping(this.value)">
    <ul id="search-results"></ul>
    <button class="btn-main" id="btn-create-manual" style="display:none; margin-top: 15px; background-color: #1976d2; color:white; box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3); width: 100%;" onclick="createManualItem()">‚ûï Crear Nuevo</button>
    <button class="btn-cancel" style="width:100%; margin-top:10px;" onclick="closeAllModals()">Cerrar</button>
</div>

<!-- MODAL PRODUCTO -->
<div id="product-modal" class="modal">
    <div class="modal-header">
        <strong>üìù Detalle Producto</strong>
        <span id="store-badge" style="background:#e3f2fd; color:#1565c0; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;"></span>
    </div>
    <div id="comparison-alert" class="price-alert"></div>
    <label style="font-size:0.8rem; color:#666;">C√≥digo:</label>
    <input type="text" id="modal-barcode" disabled>
    <input type="text" id="inp-name" placeholder="Nombre (ej: Leche)" autocomplete="off">
    <input type="tel" id="inp-price" placeholder="Precio Unidad ($)" inputmode="numeric">
    <select id="inp-category">
        <option value="despensa">ü•´ Despensa</option>
        <option value="lacteos">üßÄ L√°cteos y Huevos</option>
        <option value="frutas">ü•¶ Frutas y Verduras</option>
        <option value="carnes">ü•© Carnes y Pescados</option>
        <option value="panaderia">üçû Panader√≠a</option>
        <option value="bebidas">ü•§ Bebidas</option>
        <option value="snack">üç™ Snacks y Dulces</option>
        <option value="alcohol">üç∑ Cervezas y Licores</option>
        <option value="aseo">üßπ Limpieza y Aseo</option>
        <option value="personal">üß¥ Cuidado Personal</option>
        <option value="mascotas">üê∂ Mascotas</option>
        <option value="hogar">üè† Hogar</option>
        <option value="otros" selected>üì¶ Otros</option>
    </select>
    <div class="qty-wrapper">
        <span style="font-weight:bold; color:#555;">Cantidad:</span>
        <div class="qty-controls">
            <button class="btn-qty" onclick="adjustQty(-1)">‚àí</button>
            <span id="qty-display">1</span>
            <button class="btn-qty" onclick="adjustQty(1)">+</button>
        </div>
    </div>
    <div class="modal-btns">
        <button class="btn-cancel" onclick="closeAllModals()">Cancelar</button>
        <button class="btn-confirm" onclick="saveAndAdd()">Guardar</button>
    </div>
</div>

<div id="toast">Mensaje...</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è ATENCI√ìN: PEGA TUS CLAVES AQU√ç ABAJO
    // ==========================================
    const SUPABASE_URL = 'https://hviansyzbyzkfdmgujah.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aWFuc3l6Ynl6a2ZkbWd1amFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMTA0OTAsImV4cCI6MjA4Mjc4NjQ5MH0.1_vn4udmbsQkKRrTMiRFatpfqtRyiq_5VBgdsKjJwW8';
    // ==========================================
    
    // Inicializaci√≥n del cliente con manejo de errores simple
    let db;
    try {
        db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch(e) {
        // Fallar√° silenciosamente si las claves son placeholders, pero ya no bloquear√°.
        console.error("Error init Supabase:", e);
    }

    let cart = []; 
    let total = 0;
    let lastScannedCode = null;
    let isProcessing = false;
    let html5QrCode = null;
    let currentQty = 1;
    let isOnline = navigator.onLine;
    let currentUser = null; // Almacenar usuario logueado

    // --- AUTENTICACI√ìN ---
    async function checkSession() {
        if (!db) return;
        const { data: { session } } = await db.auth.getSession();
        if (session) {
            handleLoginSuccess(session.user);
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-content').style.display = 'none';
        }
    }
    
    // Al cargar la app, revisamos sesi√≥n
    checkSession();

    async function signInWithGoogle() {
        // YA NO HAY BLOQUEO POR NOMBRE DE CLAVE
        try {
            console.log("Iniciando login con Google...");
            const { data, error } = await db.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.href // Redirige a la misma p√°gina
                }
            });
            
            if (error) {
                console.error("Error Auth:", error);
                alert("Error de autenticaci√≥n: " + error.message);
            }
        } catch (e) {
            console.error("Excepci√≥n Login:", e);
            alert("Error cr√≠tico al intentar loguear: " + e.message);
        }
    }

    async function signOut() {
        const { error } = await db.auth.signOut();
        if (!error) {
            window.location.reload(); // Recargar para volver al login
        }
    }

    function handleLoginSuccess(user) {
        currentUser = user;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        
        // Mostrar perfil
        const profileDiv = document.getElementById('user-profile');
        const avatarUrl = user.user_metadata.avatar_url || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
        profileDiv.innerHTML = `
            <img src="${avatarUrl}" class="user-avatar" onclick="if(confirm('¬øCerrar sesi√≥n?')) signOut()">
        `;
        showToast(`Hola, ${user.user_metadata.full_name.split(' ')[0]} üëã`);
    }

    // --- EL RESTO DEL C√ìDIGO (Igual a V16) ---
    const CATEGORIES = { 'frutas': 'ü•¶ Frutas y Verduras', 'carnes': 'ü•© Carnes y Pescados', 'lacteos': 'üßÄ L√°cteos y Huevos', 'panaderia': 'üçû Panader√≠a y Pasteler√≠a', 'despensa': 'ü•´ Despensa', 'bebidas': 'ü•§ Bebidas', 'alcohol': 'üç∑ Cervezas y Licores', 'snack': 'üç™ Snacks y Dulces', 'aseo': 'üßπ Limpieza y Aseo', 'personal': 'üß¥ Cuidado Personal', 'mascotas': 'üê∂ Mascotas', 'hogar': 'üè† Hogar', 'otros': 'üì¶ Otros' };
    const CAT_ORDER = ["frutas", "carnes", "lacteos", "panaderia", "despensa", "bebidas", "alcohol", "snack", "aseo", "personal", "mascotas", "hogar", "otros"];
    const CACHE_KEY = 'scanner_pro_products';
    const QUEUE_KEY = 'scanner_pro_queue';
    const CART_KEY = 'scanner_pro_cart_session';

    function loadCartFromLocal() { const savedCart = localStorage.getItem(CART_KEY); if (savedCart) { cart = JSON.parse(savedCart); renderCart(); } }
    loadCartFromLocal();

    window.addEventListener('online', () => { isOnline = true; updateConnectionStatus(); syncOfflineData(); showToast("Conexi√≥n restaurada üåê", "success"); });
    window.addEventListener('offline', () => { isOnline = false; updateConnectionStatus(); showToast("Modo Offline activado üì°", "normal"); });
    updateConnectionStatus();

    function updateConnectionStatus() {
        const header = document.getElementById('app-header');
        const badge = document.getElementById('connection-status');
        if(isOnline) { header.classList.remove('offline'); badge.style.display = 'none'; } 
        else { header.classList.add('offline'); badge.style.display = 'inline-block'; }
    }
    
    function getLocalCache() { return JSON.parse(localStorage.getItem(CACHE_KEY) || '{}'); }
    function saveToLocalCache(product) { const cache = getLocalCache(); const key = `${product.barcode}_${product.store}`; cache[key] = product; localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); }
    function addToSyncQueue(product) { const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); queue.push(product); localStorage.setItem(QUEUE_KEY, JSON.stringify(queue)); }
    async function syncOfflineData() { const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); if (queue.length === 0) return; showToast(`Sincronizando ${queue.length} cambios...`); const remainingQueue = []; for (const item of queue) { const { error } = await db.from('products').upsert(item); if (error) remainingQueue.push(item); } localStorage.setItem(QUEUE_KEY, JSON.stringify(remainingQueue)); if (remainingQueue.length === 0) showToast("Sincronizaci√≥n completa ‚úÖ", "success"); }

    async function onScanSuccess(decodedText) { if (isProcessing || decodedText === lastScannedCode) return; isProcessing = true; lastScannedCode = decodedText; stopScanner(); checkProductInDB(decodedText, false); }

    async function checkProductInDB(code, isManualCreation) {
        const currentStore = document.getElementById('store-select').value;
        if(!isManualCreation) showToast(`üîç Buscando...`);
        let product = null;
        if (isOnline) { try { let { data } = await db.from('products').select('*').eq('barcode', code).eq('store', currentStore).single(); product = data; if(product) saveToLocalCache(product); } catch (err) {} }
        if (!product) { const cache = getLocalCache(); product = cache[`${code}_${currentStore}`]; }
        if (product) { openProductModal(code, product.name, product.price, currentStore, false, product.category); } 
        else { 
            let suggestedName = ""; let suggestedCat = "otros"; 
            if (isOnline) { let { data: other } = await db.from('products').select('name, category').eq('barcode', code).limit(1).maybeSingle(); if(other) { suggestedName = other.name; if(other.category) suggestedCat = other.category; } }
            openProductModal(code, suggestedName, "", currentStore, isManualCreation, suggestedCat); 
        }
    }

    function adjustQty(delta) { currentQty += delta; if(currentQty < 1) currentQty = 1; document.getElementById('qty-display').innerText = currentQty; }

    async function checkCrossStorePrice(code, currentStore, currentPrice) {
        if (!isOnline) return;
        const alertBox = document.getElementById('comparison-alert');
        alertBox.style.display = 'none'; alertBox.className = 'price-alert';
        const { data: bestOption } = await db.from('products').select('store, price').eq('barcode', code).neq('store', currentStore).order('price', { ascending: true }).limit(1).maybeSingle();
        if (bestOption) {
            if (currentPrice && bestOption.price < currentPrice) {
                const diff = currentPrice - bestOption.price;
                alertBox.innerHTML = `‚ö†Ô∏è <b>¬°M√°s barato en ${bestOption.store.toUpperCase()}!</b><br>All√° cuesta $${bestOption.price}. Ahorras $${diff}.`;
                alertBox.classList.add('cheaper'); alertBox.style.display = 'block';
            } else if (!currentPrice) {
                alertBox.innerHTML = `‚ÑπÔ∏è <b>Referencia:</b><br>Mejor precio: $${bestOption.price} en ${bestOption.store.toUpperCase()}.`;
                alertBox.classList.add('info'); alertBox.style.display = 'block';
            }
        }
    }

    function openProductModal(code, name, price, store, isEditableBarcode, category = 'otros') {
        currentQty = 1; document.getElementById('qty-display').innerText = "1";
        document.getElementById('overlay-bg').style.display = 'block';
        document.getElementById('product-modal').style.display = 'block';
        checkCrossStorePrice(code, store, price);
        const barcodeInput = document.getElementById('modal-barcode');
        barcodeInput.value = code; barcodeInput.disabled = !isEditableBarcode;
        barcodeInput.style.border = isEditableBarcode ? "1px solid #2e7d32" : "1px dashed #ccc";
        barcodeInput.style.backgroundColor = isEditableBarcode ? "#fff" : "#f9f9f9";
        document.getElementById('inp-name').value = name;
        document.getElementById('inp-price').value = price;
        document.getElementById('inp-category').value = category || 'otros';
        document.getElementById('store-badge').innerText = store.toUpperCase();
        if(price) document.querySelector('.btn-confirm').focus(); else if(name) document.getElementById('inp-price').focus(); else document.getElementById('inp-name').focus();
    }

    function closeAllModals() {
        document.getElementById('overlay-bg').style.display = 'none'; document.getElementById('product-modal').style.display = 'none'; document.getElementById('search-modal').style.display = 'none'; document.getElementById('comparison-alert').style.display = 'none'; isProcessing = false; lastScannedCode = null;
    }

    async function saveAndAdd() {
        const name = document.getElementById('inp-name').value;
        const price = parseInt(document.getElementById('inp-price').value);
        const store = document.getElementById('store-select').value;
        const category = document.getElementById('inp-category').value;
        const finalBarcode = document.getElementById('modal-barcode').value.trim();
        if (!name || isNaN(price) || !finalBarcode) { showToast("‚ö†Ô∏è Faltan datos", "alert"); return; }
        
        // AGREGAR USER_ID SI EST√Å LOGUEADO
        const productData = { 
            barcode: finalBarcode, store: store, name: name, price: price, category: category,
            updated_by: currentUser ? currentUser.id : null // Guardamos quien edit√≥
        };

        saveToLocalCache(productData);
        if (isOnline) {
            const { error } = await db.from('products').upsert(productData);
            if (!error) finalizeSave(productData, currentQty); else { addToSyncQueue(productData); finalizeSave(productData, currentQty, true); }
        } else {
            addToSyncQueue(productData); finalizeSave(productData, currentQty, true);
        }
    }

    function finalizeSave(product, qty, offlineMode = false) { addToCart(product, qty); const msg = offlineMode ? "Guardado en local üì°" : "Guardado exitoso ‚úÖ"; showToast(msg, "success"); closeAllModals(); }
    function addToCart(product, qty) { const cartItem = { id: Date.now() + Math.random(), name: product.name, price: product.price, category: product.category || 'otros', qty: qty, subtotal: product.price * qty }; cart.push(cartItem); saveCartToLocal(); renderCart(); }
    function removeFromCart(id) { if(navigator.vibrate) navigator.vibrate(50); if(!confirm("¬øBorrar item?")) return; cart = cart.filter(item => item.id !== id); saveCartToLocal(); renderCart(); }
    function clearCart() { if(cart.length === 0) return; if(confirm("¬øVaciar carrito?")) { cart = []; saveCartToLocal(); renderCart(); showToast("Carrito vaciado"); } }
    function saveCartToLocal() { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

    function renderCart() {
        const list = document.getElementById('cart-list'); list.innerHTML = "";
        let calculatedTotal = 0; const grouped = {};
        cart.forEach(item => { if(!grouped[item.category]) grouped[item.category] = []; grouped[item.category].push(item); calculatedTotal += item.subtotal; });
        const keys = Object.keys(grouped).sort((a,b) => { let ia = CAT_ORDER.indexOf(a); let ib = CAT_ORDER.indexOf(b); if(ia === -1) ia = 99; if(ib === -1) ib = 99; return ia - ib; });
        keys.forEach(cat => {
            const header = document.createElement('li'); header.className = 'category-header'; header.innerText = CATEGORIES[cat] || cat.toUpperCase(); list.appendChild(header);
            grouped[cat].forEach(item => {
                const li = document.createElement('li'); li.className = 'product-item';
                const qtyBadge = item.qty > 1 ? `<span class="item-qty-badge">${item.qty}x</span>` : '';
                const displayPrice = item.qty > 1 ? `$${item.subtotal.toLocaleString()} <small style='color:#999'>($${item.price} c/u)</small>` : `$${item.price.toLocaleString()}`;
                li.innerHTML = `<div style="flex-grow:1"><span style="font-weight:600; font-size:1rem;">${qtyBadge} ${item.name}</span><br><span style="color:#666; font-size:0.9rem;">${displayPrice}</span></div><button class="btn-delete" onclick="removeFromCart(${item.id})">√ó</button>`;
                list.appendChild(li);
            });
        });
        total = calculatedTotal; updateTotalDisplay();
    }

    function updateTotalDisplay() { const amountEl = document.getElementById('total-amount'); const boxEl = document.querySelector('.total-box'); const limitInput = document.getElementById('budget-limit').value; amountEl.innerText = '$' + total.toLocaleString(); amountEl.className = 'total-price'; boxEl.className = 'total-box'; if (limitInput && parseInt(limitInput) > 0) { const limit = parseInt(limitInput); if (total > limit) { amountEl.classList.add('danger'); boxEl.classList.add('danger'); if(navigator.vibrate) navigator.vibrate([200, 100, 200]); } else if (total > limit * 0.9) amountEl.classList.add('warning'); } }
    function handleStoreChange() { if(cart.length > 0 && confirm("¬øCambiaste de tienda? Se limpiar√° el carrito.")) { clearCart(); } }
    function showToast(msg, type="normal") { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show " + type; setTimeout(()=> x.className=x.className.replace("show "+type,""), 3000); }
    function openSearchModal() { document.getElementById('overlay-bg').style.display = 'block'; document.getElementById('search-modal').style.display = 'block'; document.getElementById('search-input').focus(); }
    function createManualItem() { const text = document.getElementById('search-input').value; if(!text) return; closeAllModals(); const currentStore = document.getElementById('store-select').value; const isNumeric = /^\d+$/.test(text); const code = isNumeric ? text : 'MAN-' + Date.now(); const name = isNumeric ? "" : text; openProductModal(code, name, "", currentStore, true); }
    let debounceTimer;
    function handleSearchTyping(text) { const btn = document.getElementById('btn-create-manual'); btn.style.display = text.length > 0 ? 'block' : 'none'; if(text.length > 0) btn.innerText = /^\d+$/.test(text) ? `‚ûï Registrar: ${text}` : `‚ûï Crear: "${text}"`; clearTimeout(debounceTimer); debounceTimer = setTimeout(() => searchInDB(text), 300); }
    async function searchInDB(text) { if(text.length < 2) return; if (!isOnline) { const cache = getLocalCache(); const results = Object.values(cache).filter(p => p.name.toLowerCase().includes(text.toLowerCase()) || p.barcode.startsWith(text)); renderSearchResults(results); return; } let query = db.from('products').select('*').limit(5); if (/^\d+$/.test(text)) query = query.ilike('barcode', `${text}%`); else query = query.ilike('name', `%${text}%`); let { data: results } = await query; renderSearchResults(results); }
    function renderSearchResults(results) { const list = document.getElementById('search-results'); list.innerHTML = ''; if(results?.length) { results.forEach(p => { const li = document.createElement('li'); li.className = 'search-result-item'; li.innerHTML = `<div style="flex-grow:1; margin-right:10px;"><span style="font-weight:600;">${p.name}</span><small style="color:#666; display:block;">${p.store.toUpperCase()}</small></div><b>$${p.price}</b>`; li.onclick = () => { closeAllModals(); openProductModal(p.barcode, p.name, p.price, p.store, false, p.category); }; list.appendChild(li); }); } else { list.innerHTML = '<li style="padding:10px;color:#666">Sin resultados</li>'; } }
    function startScanner() { document.getElementById('scanner-container').style.display = 'block'; html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 }, formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8 ] }, onScanSuccess).catch(err => html5QrCode.start({ facingMode: "user" }, { fps: 10, qrbox: 250 }, onScanSuccess)); }
    function stopScanner() { if(html5QrCode) html5QrCode.stop().then(() => { document.getElementById('scanner-container').style.display = 'none'; html5QrCode.clear(); }).catch(e=>console.error(e)); else document.getElementById('scanner-container').style.display = 'none'; }
</script>

</body>
</html>
