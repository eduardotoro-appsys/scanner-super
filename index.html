<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Multi-S√∫per</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; }
        
        /* HEADER CON SELECTOR */
        header { background-color: #2e7d32; padding: 10px; display: flex; flex-direction: column; align-items: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 1rem; color: white; margin-bottom: 5px; opacity: 0.8; }
        
        /* El selector de supermercado */
        #store-select {
            font-size: 1.1rem; padding: 8px; border-radius: 8px; border: none; font-weight: bold; width: 90%; max-width: 300px; text-align: center;
            background: white; color: #2e7d32; outline: none;
        }

        #scanner-container { width: 100%; background: black; min-height: 250px; position: relative; overflow: hidden;}
        #reader video { width: 100%; height: auto; object-fit: contain !important; }
        
        .dashboard { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        .btn-main { width: 100%; padding: 15px; background-color: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; margin-bottom: 15px; cursor: pointer; }
        
        .total-box { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .total-price { font-size: 2.5rem; font-weight: 800; color: #2e7d32; margin-top: 5px; }

        .product-list { list-style: none; padding: 0; }
        .product-item { background: white; border-bottom: 1px solid #f0f0f0; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btn-delete { background: #e53935; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-left: 10px; }

        /* MODAL */
        #product-modal { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 25px 20px; border-radius: 20px 20px 0 0; z-index: 100; box-shadow: 0 -4px 30px rgba(0,0,0,0.3); }
        input { width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 1.1rem; box-sizing: border-box; margin-bottom: 15px; }
        .modal-btns { display: flex; gap: 10px; }
        .btn-confirm { flex: 2; background: #2e7d32; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; }
        .btn-cancel { flex: 1; background: #f5f5f5; color: #333; padding: 15px; border: none; border-radius: 8px; font-weight: bold; }

        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 101; left: 50%; bottom: 30px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
    </style>
</head>
<body>

<header>
    <h1>Est√°s comprando en:</h1>
    <select id="store-select" onchange="resetCart()">
        <option value="lider">üîµ Lider</option>
        <option value="jumbo">üêò Jumbo</option>
        <option value="unimarc">üî¥ Unimarc</option>
        <option value="tottus">üü¢ Tottus</option>
        <option value="mayorista">üì¶ Mayorista</option>
        <option value="otro">üè™ Almac√©n / Otro</option>
    </select>
</header>

<div id="scanner-container">
    <div id="reader"></div>
</div>

<div class="dashboard">
    <button id="start-btn" class="btn-main" onclick="startScanner()">üì∑ Activar C√°mara</button>
    
    <div class="total-box">
        <small>Total Carrito</small>
        <div class="total-price" id="total-amount">$0</div>
    </div>

    <ul class="product-list" id="cart-list"></ul>
</div>

<div id="product-modal">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <strong>üìù Validar Precio</strong>
        <span id="store-badge" style="background:#e3f2fd; color:#1565c0; padding:2px 6px; border-radius:4px; font-size:0.8rem;"></span>
    </div>
    
    <div style="font-size: 0.8rem; color: #666; margin-bottom: 10px;" id="modal-barcode">...</div>
    
    <input type="text" id="inp-name" placeholder="Nombre (ej: Coca Cola)">
    <input type="tel" id="inp-price" placeholder="Precio ($)" inputmode="numeric">
    
    <div class="modal-btns">
        <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
        <button class="btn-confirm" onclick="saveAndAdd()">Guardar</button>
    </div>
</div>

<div id="toast">Mensaje...</div>

<script>
    // --- CLAVES SUPABASE ---
    const SUPABASE_URL = 'https://hviansyzbyzkfdmgujah.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_sfFASSOkI15dXpf5vulSRQ_f5EZTW4_';
    // -----------------------
    
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let total = 0;
    let lastScannedCode = null;
    let isProcessing = false;
    let currentBarcode = null;

    // --- ESCANEO INTELIGENTE ---
    async function onScanSuccess(decodedText) {
        if (isProcessing || decodedText === lastScannedCode) return;
        
        isProcessing = true;
        lastScannedCode = decodedText;
        
        // 1. OBTENER SUPERMERCADO ACTUAL
        const currentStore = document.getElementById('store-select').value;
        showToast(`üîç Buscando en ${currentStore.toUpperCase()}...`);

        try {
            // 2. BUSCAR PRECIO SOLO EN ESTE SUPERMERCADO
            let { data: product } = await db
                .from('products')
                .select('*')
                .eq('barcode', decodedText)
                .eq('store', currentStore) // <--- FILTRO IMPORTANTE
                .single();

            if (product) {
                // Existe en este s√∫per: Abrir con precio conocido
                openModal(decodedText, product.name, product.price, currentStore);
            } else {
                // No existe en este s√∫per: Intentar buscar el nombre en otros (para no escribirlo de nuevo)
                let { data: otherStoreProduct } = await db
                    .from('products')
                    .select('name')
                    .eq('barcode', decodedText)
                    .limit(1)
                    .maybeSingle(); // maybeSingle no da error si no encuentra nada
                
                // Si existe en otro lado, usamos ese nombre, si no, vac√≠o.
                const suggestedName = otherStoreProduct ? otherStoreProduct.name : "";
                openModal(decodedText, suggestedName, "", currentStore);
            }

        } catch (err) {
            console.error(err);
            isProcessing = false;
        }
    }

    // --- FORMULARIO ---
    function openModal(code, name, price, store) {
        currentBarcode = code;
        document.getElementById('modal-barcode').innerText = code;
        document.getElementById('inp-name').value = name;
        document.getElementById('inp-price').value = price;
        document.getElementById('store-badge').innerText = store.toUpperCase();
        
        document.getElementById('product-modal').style.display = 'block';
        
        // Foco inteligente
        if(price) document.querySelector('.btn-confirm').focus();
        else if(name) document.getElementById('inp-price').focus();
        else document.getElementById('inp-name').focus();
    }

    function closeModal() {
        document.getElementById('product-modal').style.display = 'none';
        setTimeout(() => { isProcessing = false; lastScannedCode = null; }, 1000);
    }

    async function saveAndAdd() {
        const name = document.getElementById('inp-name').value;
        const price = parseInt(document.getElementById('inp-price').value);
        const store = document.getElementById('store-select').value;

        if (!name || isNaN(price)) { showToast("‚ö†Ô∏è Faltan datos"); return; }

        // GUARDAR: Incluyendo la tienda
        const { error } = await db
            .from('products')
            .upsert({ 
                barcode: currentBarcode, 
                store: store,    // <--- CLAVE NUEVA
                name: name, 
                price: price 
            });

        if (!error) {
            addToCart(name, price);
            showToast("‚úÖ Guardado en " + store);
            closeModal();
        } else {
            showToast("Error: " + error.message);
        }
    }

    // --- CARRITO ---
    function addToCart(name, price) {
        total += price;
        updateTotalDisplay();
        const ul = document.getElementById('cart-list');
        const li = document.createElement('li');
        li.className = 'product-item';
        li.innerHTML = `<div><strong>${name}</strong><br><small>$${price}</small></div><button class="btn-delete" onclick="removeFromCart(this, ${price})">üóëÔ∏è</button>`;
        ul.insertBefore(li, ul.firstChild);
    }

    function removeFromCart(btn, price) {
        total -= price; if(total < 0) total = 0;
        updateTotalDisplay();
        btn.parentElement.remove();
    }

    function resetCart() {
        // Opcional: Limpiar carrito al cambiar de s√∫per
        if(confirm("¬øCambiaste de Supermercado? Se limpiar√° el carrito actual.")) {
            total = 0;
            updateTotalDisplay();
            document.getElementById('cart-list').innerHTML = "";
            showToast("Carrito nuevo para nueva tienda");
        }
    }

    function updateTotalDisplay() { document.getElementById('total-amount').innerText = '$' + total.toLocaleString(); }
    function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000); }

    function startScanner() {
        try {
            const html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 150 }, formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8 ] };
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .then(() => { document.getElementById('start-btn').style.display = 'none'; })
            .catch(err => { html5QrCode.start({ facingMode: "user" }, config, onScanSuccess); });
        } catch (e) { alert(e); }
    }
</script>

</body>
</html>
