<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Precios Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; }
        
        header { 
            background-color: #2e7d32; padding: 10px; display: flex; flex-direction: column; 
            align-items: center; position: sticky; top: 0; z-index: 10; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
        }
        h1 { margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.9); margin-bottom: 5px; font-weight: normal; }
        
        #store-select {
            font-size: 1.1rem; padding: 8px 12px; border-radius: 8px; border: none; 
            font-weight: bold; width: 95%; max-width: 300px; text-align: center;
            background: white; color: #2e7d32; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        #scanner-container { width: 100%; background: black; min-height: 250px; position: relative; overflow: hidden; display: none; }
        #reader video { width: 100%; height: auto; object-fit: contain !important; }
        
        .dashboard { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        
        /* BOTONES PRINCIPALES */
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-main { 
            flex: 1; padding: 15px; background-color: #2e7d32; color: white; 
            border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; 
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary {
            flex: 1; padding: 15px; background-color: #1976d2; color: white;
            border: none; border-radius: 8px; font-size: 1rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        .total-box { 
            background: white; padding: 20px; border-radius: 12px; text-align: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; border: 1px solid #e0e0e0;
        }
        .total-price { font-size: 2.5rem; font-weight: 800; color: #2e7d32; margin-top: 5px; }

        .product-list { list-style: none; padding: 0; }
        .product-item { 
            background: white; border-bottom: 1px solid #f0f0f0; padding: 15px; 
            display: flex; justify-content: space-between; align-items: center; 
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .item-info { flex-grow: 1; }
        .item-name { font-weight: 600; font-size: 1rem; display: block; }
        .item-price { color: #666; font-size: 0.9rem; }
        
        .btn-delete { 
            background: #ffcdd2; color: #c62828; border: none; padding: 8px 12px; 
            border-radius: 6px; margin-left: 10px; cursor: pointer; font-size: 1.2rem;
        }

        /* MODALES COMUNES */
        .modal { 
            display: none; position: fixed; bottom: 0; left: 0; right: 0; 
            background: white; padding: 25px 20px; border-radius: 20px 20px 0 0; 
            z-index: 100; box-shadow: 0 -4px 30px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        input { 
            width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 1.1rem; box-sizing: border-box; margin-bottom: 15px; 
            -webkit-appearance: none;
        }
        /* Estilo especial para el input del c√≥digo de barras */
        #modal-barcode {
            font-family: monospace; font-size: 0.9rem; color: #666; 
            background: #f9f9f9; margin-bottom: 10px;
            border: 1px dashed #ccc;
        }
        #modal-barcode:disabled {
            background: transparent; border: none; color: #333; padding: 0; margin-bottom: 10px;
        }
        
        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .btn-confirm { flex: 2; background: #2e7d32; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-cancel { flex: 1; background: #f5f5f5; color: #333; padding: 15px; border: none; border-radius: 8px; font-weight: bold; }

        /* LISTA DE RESULTADOS DE B√öSQUEDA */
        #search-results { list-style: none; padding: 0; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .search-result-item { 
            padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; 
            display: flex; justify-content: space-between;
        }
        .search-result-item:active { background-color: #f0f0f0; }

        #toast { 
            visibility: hidden; min-width: 250px; margin-left: -125px; 
            background-color: #333; color: #fff; text-align: center; border-radius: 50px; 
            padding: 16px; position: fixed; z-index: 101; left: 50%; bottom: 30px; 
            opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-weight: 500;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #overlay-bg {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 90;
        }
    </style>
</head>
<body>

<header>
    <h1>Est√°s en:</h1>
    <select id="store-select" onchange="handleStoreChange()">
        <option value="lider">üîµ Lider</option>
        <option value="jumbo">üêò Jumbo</option>
        <option value="unimarc">üî¥ Unimarc</option>
        <option value="tottus">üü¢ Tottus</option>
        <option value="acuenta">üõí aCuenta</option>
        <option value="santa_isabel">üêº Santa Isabel</option>
        <option value="mayorista">üì¶ Mayorista</option>
        <option value="otro">üè™ Almac√©n / Otro</option>
    </select>
</header>

<div id="scanner-container">
    <div id="reader"></div>
    <button onclick="stopScanner()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; padding:5px 10px; border-radius:4px;">Cerrar X</button>
</div>

<div class="dashboard">
    <div class="btn-group">
        <button id="start-btn" class="btn-main" onclick="startScanner()">
            üì∑ Escanear
        </button>
        <button class="btn-secondary" onclick="openSearchModal()">
            ‚úçÔ∏è Manual
        </button>
    </div>
    
    <div class="total-box">
        <small>Total Carrito</small>
        <div class="total-price" id="total-amount">$0</div>
    </div>

    <ul class="product-list" id="cart-list"></ul>
</div>

<!-- FONDO OSCURO -->
<div id="overlay-bg" onclick="closeAllModals()"></div>

<!-- MODAL 1: B√öSQUEDA MANUAL -->
<div id="search-modal" class="modal">
    <div class="modal-header">
        <strong>üîç Buscar o Crear</strong>
    </div>
    <input type="text" id="search-input" placeholder="Nombre o C√≥digo (ej: 780...)" onkeyup="handleSearchTyping(this.value)">
    
    <ul id="search-results"></ul>

    <button class="btn-main" id="btn-create-manual" style="display:none; background:#555;" onclick="createManualItem()">
        ‚ûï Crear Nuevo
    </button>
    <button class="btn-cancel" style="width:100%; margin-top:10px;" onclick="closeAllModals()">Cerrar</button>
</div>

<!-- MODAL 2: EDICI√ìN DE PRODUCTO -->
<div id="product-modal" class="modal">
    <div class="modal-header">
        <strong>üìù Detalle Producto</strong>
        <span id="store-badge" style="background:#e3f2fd; color:#1565c0; padding:4px 8px; border-radius:4px; font-size:0.8rem; font-weight:bold;"></span>
    </div>
    
    <!-- AHORA ES UN INPUT -->
    <label style="font-size:0.8rem; color:#666;">C√≥digo de Barras:</label>
    <input type="text" id="modal-barcode" placeholder="C√≥digo de barras" disabled>
    
    <input type="text" id="inp-name" placeholder="Nombre (ej: Coca Cola)" autocomplete="off">
    <input type="tel" id="inp-price" placeholder="Precio ($)" inputmode="numeric">
    
    <div class="modal-btns">
        <button class="btn-cancel" onclick="closeAllModals()">Cancelar</button>
        <button class="btn-confirm" onclick="saveAndAdd()">Guardar</button>
    </div>
</div>

<div id="toast">Mensaje...</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è PEGA TUS CLAVES DE SUPABASE AQU√ç
    // ==========================================
    const SUPABASE_URL = 'https://hviansyzbyzkfdmgujah.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_sfFASSOkI15dXpf5vulSRQ_f5EZTW4_';
    // ==========================================
    
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let total = 0;
    let lastScannedCode = null;
    let isProcessing = false;
    let html5QrCode = null;

    // --- 1. L√ìGICA DE ESCANEO ---
    async function onScanSuccess(decodedText) {
        if (isProcessing || decodedText === lastScannedCode) return;
        isProcessing = true;
        lastScannedCode = decodedText;
        stopScanner();
        // Al escanear, el c√≥digo NO debe ser editable para evitar errores
        checkProductInDB(decodedText, false);
    }

    async function checkProductInDB(code, isManualCreation) {
        const currentStore = document.getElementById('store-select').value;
        if(!isManualCreation) showToast(`üîç Buscando...`);

        try {
            // A. Buscar en tienda actual
            let { data: product } = await db.from('products').select('*').eq('barcode', code).eq('store', currentStore).single();

            if (product) {
                // Si existe, abrimos modal (c√≥digo NO editable si viene del esc√°ner)
                openProductModal(code, product.name, product.price, currentStore, false);
            } else {
                // B. Si no existe, buscamos nombre sugerido
                let { data: other } = await db.from('products').select('name').eq('barcode', code).limit(1).maybeSingle();
                const suggested = other ? other.name : "";
                
                // Si es creaci√≥n manual, permitimos editar el c√≥digo. Si es escaneo, no.
                openProductModal(code, suggested, "", currentStore, isManualCreation);
            }
        } catch (err) {
            console.error(err);
            showToast("Error de conexi√≥n", "alert");
            isProcessing = false;
        }
    }

    // --- 2. B√öSQUEDA MANUAL ---
    function openSearchModal() {
        document.getElementById('overlay-bg').style.display = 'block';
        document.getElementById('search-modal').style.display = 'block';
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
        document.getElementById('btn-create-manual').style.display = 'none';
        document.getElementById('search-input').focus();
    }

    let debounceTimer;
    function handleSearchTyping(text) {
        const btnCreate = document.getElementById('btn-create-manual');
        if(text.length > 0) {
            btnCreate.style.display = 'block';
            // Cambiar texto del bot√≥n seg√∫n si parece c√≥digo o nombre
            const isNumeric = /^\d+$/.test(text);
            btnCreate.innerText = isNumeric ? `‚ûï Registrar C√≥digo: ${text}` : `‚ûï Crear Nuevo: "${text}"`;
        } else {
            btnCreate.style.display = 'none';
        }

        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => searchInDB(text), 500);
    }

    async function searchInDB(text) {
        if(text.length < 2) return;
        
        // Buscamos por nombre O por c√≥digo exacto
        let query = db.from('products').select('*').limit(5);
        
        // Si es solo n√∫meros, buscamos match exacto de c√≥digo, si no, nombre parcial
        if (/^\d+$/.test(text)) {
            query = query.eq('barcode', text);
        } else {
            query = query.ilike('name', `%${text}%`);
        }

        let { data: results } = await query;
        const list = document.getElementById('search-results');
        list.innerHTML = '';

        if(results && results.length > 0) {
            results.forEach(p => {
                const li = document.createElement('li');
                li.className = 'search-result-item';
                li.innerHTML = `<span>${p.name}</span> <b>$${p.price}</b>`;
                li.onclick = () => {
                    closeAllModals();
                    // Al abrir uno existente, NO permitimos editar el c√≥digo
                    openProductModal(p.barcode, p.name, p.price, p.store, false); 
                };
                list.appendChild(li);
            });
        } else {
            list.innerHTML = '<li style="padding:10px; color:#666;">Sin resultados.</li>';
        }
    }

    function createManualItem() {
        const text = document.getElementById('search-input').value;
        if(!text) return;
        closeAllModals();
        
        const currentStore = document.getElementById('store-select').value;
        const isNumeric = /^\d+$/.test(text);

        let code, name;
        
        if (isNumeric) {
            // Si el usuario escribi√≥ n√∫meros, asumimos que ESO es el c√≥digo de barras
            code = text;
            name = "";
        } else {
            // Si escribi√≥ texto, generamos c√≥digo temporal
            code = 'MAN-' + Date.now();
            name = text;
        }

        // Abrimos modal permitiendo EDITAR el c√≥digo (true)
        openProductModal(code, name, "", currentStore, true);
    }

    // --- 3. MODAL DE PRODUCTO (Edici√≥n) ---
    function openProductModal(code, name, price, store, isEditableBarcode) {
        document.getElementById('overlay-bg').style.display = 'block';
        document.getElementById('product-modal').style.display = 'block';
        
        // Configurar campo de c√≥digo
        const barcodeInput = document.getElementById('modal-barcode');
        barcodeInput.value = code;
        barcodeInput.disabled = !isEditableBarcode; // Activar o desactivar seg√∫n el caso
        
        // Foco visual si est√° habilitado
        if(isEditableBarcode) {
            barcodeInput.style.border = "1px solid #2e7d32";
            barcodeInput.style.backgroundColor = "#fff";
        } else {
            barcodeInput.style.border = "1px dashed #ccc";
            barcodeInput.style.backgroundColor = "#f9f9f9";
        }

        document.getElementById('inp-name').value = name;
        document.getElementById('inp-price').value = price;
        document.getElementById('store-badge').innerText = store.toUpperCase();

        if(price) document.querySelector('.btn-confirm').focus();
        else if(name) document.getElementById('inp-price').focus();
        else document.getElementById('inp-name').focus();
    }

    function closeAllModals() {
        document.getElementById('overlay-bg').style.display = 'none';
        document.getElementById('product-modal').style.display = 'none';
        document.getElementById('search-modal').style.display = 'none';
        isProcessing = false;
        lastScannedCode = null;
    }

    // --- 4. GUARDAR ---
    async function saveAndAdd() {
        const name = document.getElementById('inp-name').value;
        const price = parseInt(document.getElementById('inp-price').value);
        const store = document.getElementById('store-select').value;
        
        // IMPORTANTE: Leemos el c√≥digo del input, por si el usuario lo edit√≥
        const finalBarcode = document.getElementById('modal-barcode').value.trim();

        if (!name || isNaN(price) || !finalBarcode) { 
            showToast("‚ö†Ô∏è Faltan datos", "alert"); 
            return; 
        }

        const { error } = await db.from('products').upsert({ 
            barcode: finalBarcode, 
            store: store, 
            name: name, 
            price: price 
        });

        if (!error) {
            addToCart(name, price);
            showToast(`‚úÖ ${name} agregado`, "success");
            closeAllModals();
        } else {
            showToast("Error: " + error.message, "alert");
        }
    }

    // --- 5. CARRITO ---
    function addToCart(name, price) {
        total += price;
        updateTotalDisplay();
        const ul = document.getElementById('cart-list');
        const li = document.createElement('li');
        li.className = 'product-item';
        li.innerHTML = `<div class="item-info"><span class="item-name">${name}</span><span class="item-price">$${price.toLocaleString()}</span></div><button class="btn-delete" onclick="removeFromCart(this, ${price})">√ó</button>`;
        ul.insertBefore(li, ul.firstChild);
    }

    function removeFromCart(btn, price) {
        if(navigator.vibrate) navigator.vibrate(50);
        total -= price; if(total < 0) total = 0;
        updateTotalDisplay();
        btn.parentElement.remove();
    }

    function handleStoreChange() {
        if(total > 0 && confirm("¬øCambiaste de Supermercado? Se vaciar√° el carrito.")) {
            total = 0; updateTotalDisplay(); document.getElementById('cart-list').innerHTML = "";
        }
    }
    function updateTotalDisplay() { document.getElementById('total-amount').innerText = '$' + total.toLocaleString(); }
    function showToast(msg, type="normal") { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show " + type; setTimeout(()=> x.className=x.className.replace("show "+type,""), 3000); }

    // --- 6. C√ÅMARA ---
    function startScanner() {
        document.getElementById('scanner-container').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 150 }, formatsToSupport: [ Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8 ] };
        
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => { 
            console.warn("Fallo trasera", err);
            html5QrCode.start({ facingMode: "user" }, config, onScanSuccess); 
        });
    }

    function stopScanner() {
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('scanner-container').style.display = 'none';
                html5QrCode.clear();
            }).catch(err => console.error("Error stop", err));
        } else {
            document.getElementById('scanner-container').style.display = 'none';
        }
    }
</script>

</body>
</html>
