<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro V33.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; color: #333; }
        
        /* PANTALLA DE LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            z-index: 2000; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; color: white;
            padding: 20px; box-sizing: border-box; text-align: center;
        }
        .login-logo { font-size: 4rem; margin-bottom: 20px; }
        .login-title { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; }
        .login-desc { font-size: 1rem; opacity: 0.9; margin-bottom: 40px; max-width: 300px; }
        
        .btn-google {
            background: white; color: #333; border: none; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; font-size: 1rem;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s;
        }
        .btn-google img { width: 20px; height: 20px; }

        /* HEADER APP */
        header { 
            background-color: #2e7d32; padding: 8px 15px 12px 15px; 
            display: flex; flex-direction: column; align-items: center; 
            position: sticky; top: 0; z-index: 100; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: background-color 0.3s;
        }
        header.offline { background-color: #455a64; }

        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .connection-badge { font-size: 0.75rem; color: white; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 12px; display: none; }
        .sync-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 15px; padding: 4px 10px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 500; }
        .sync-btn.pending { background: #ff9800; border-color: #f57c00; animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(255, 152, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); } }
        .user-profile { display: flex; align-items: center; gap: 8px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; border: 2px solid white; cursor: pointer;}
        .reset-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 5px; opacity: 0.8; }

        /* NUEVA BARRA DE UBICACI√ìN (ESTILO DELIVERY) */
        .location-bar {
            width: 100%; max-width: 400px; background: rgba(255,255,255,0.15);
            border-radius: 12px; padding: 10px 15px; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
            color: white; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
            transition: background 0.2s;
        }
        .location-bar:active { background: rgba(255,255,255,0.25); }
        .location-info { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .location-info b { font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 250px; }

        .header-controls { display: flex; gap: 10px; width: 100%; max-width: 400px; }
        .btn-main { flex: 2; background-color: white; color: #2e7d32; padding: 12px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-secondary { flex: 1; background-color: rgba(255,255,255,0.25); color: white; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* DASHBOARD */
        #app-content { display: none; }
        #scanner-container { width: 100%; background: black; min-height: 250px; position: relative; overflow: hidden; display: none; }
        #reader video { width: 100%; height: auto; object-fit: contain !important; }
        .dashboard { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }
        .total-box { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.06); margin-bottom: 15px; border: 2px solid transparent; }
        .total-price { font-size: 2.8rem; font-weight: 900; color: #2e7d32; margin: 5px 0; }
        .total-price.danger { color: #d32f2f; }
        
        .cart-actions-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .btn-toggle-view { background: #f5f5f5; border: 1px solid #ddd; color: #555; padding: 8px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: 600; }
        .btn-clear-cart { background: #fff1f0; border: 1px solid #ffa39e; color: #cf1322; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; font-weight: 600; }

        /* LISTA */
        .product-list { list-style: none; padding: 0; }
        .category-header { background: #f6ffed; color: #389e0d; padding: 10px 15px; border-radius: 8px; font-weight: 800; margin-top: 20px; margin-bottom: 8px; font-size: 0.8rem; border-left: 4px solid #52c41a; text-transform: uppercase; letter-spacing: 0.5px; }
        .product-item { background: white; border-radius: 12px; margin-bottom: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .item-qty-badge { background: #2e7d32; color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; flex-shrink: 0; }
        .btn-delete { background: #fff1f0; color: #f5222d; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        /* MODALES */
        .modal { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 25px 20px; border-radius: 24px 24px 0 0; z-index: 1000; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        input, select { width: 100%; padding: 14px; border: 1.5px solid #eee; border-radius: 12px; font-size: 1rem; box-sizing: border-box; margin-bottom: 12px; outline: none; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: #2e7d32; }
        .modal-btns { display: flex; gap: 10px; margin-top: 15px; }
        .btn-confirm { flex: 2; background: #2e7d32; color: white; padding: 16px; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; }
        .btn-cancel { flex: 1; background: #f5f5f5; color: #666; padding: 16px; border: none; border-radius: 12px; font-weight: bold; }

        .styled-select { -webkit-appearance: none; appearance: none; background: #fff url("data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2212%22%20height%3D%2212%22%20viewBox%3D%220%200%2012%2012%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M10.293%203.293L6%207.586%201.707%203.293A1%201%200%2000.293%204.707l5%205a1%201%200%20001.414%200l5-5a1%201%200%2010-1.414-1.414z%22%2F%3E%3C%2Fsvg%3E") no-repeat right 15px center; }

        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 14px 24px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: all 0.3s; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #overlay-bg { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 999; }
        
        .unit-selector { display: flex; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
        .unit-option { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #f9f9f9; border: none; font-weight: 500; font-size: 0.9rem; }
        .unit-option.active { background: #2e7d32; color: white; font-weight: bold; }
        .qty-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; background: #f5f5f5; padding: 10px; border-radius: 8px; }
        .qty-controls { display: flex; align-items: center; gap: 15px; width: 50%; justify-content: flex-end; }
        .btn-qty { width: 40px; height: 40px; border-radius: 50%; border: none; background: #fff; color: #2e7d32; font-size: 1.5rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #qty-display { font-size: 1.5rem; font-weight: bold; min-width: 30px; text-align: center; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-logo">üõí</div>
    <div class="login-title">Scanner Pro</div>
    <div class="login-desc">Tu asistente inteligente para compras con sucursales din√°micas.</div>
    <button class="btn-google" onclick="signInWithGoogle()">
        <img src="https://cdn-icons-png.flaticon.com/512/300/300221.png" alt="G">
        Ingresar con Google
    </button>
</div>

<div id="app-content">
    <header id="app-header">
        <div class="top-bar">
            <div id="connection-status" class="connection-badge">üì° Offline</div>
            <button id="sync-btn" class="sync-btn" onclick="syncOfflineData()">‚òÅÔ∏è Al d√≠a</button>
            <div class="user-profile" id="user-profile"></div>
            <button class="reset-btn" onclick="resetApp()">üõ†Ô∏è</button>
        </div>

        <!-- BARRA DE UBICACI√ìN COMPACTA -->
        <div class="location-bar" onclick="openLocationModal()">
            <div class="location-info">
                <span>üìç</span>
                <b id="display-location">Cargando ubicaci√≥n...</b>
            </div>
            <span style="font-size: 0.7rem; opacity: 0.8;">CAMBIAR ‚ñº</span>
        </div>

        <div class="header-controls">
            <button id="start-btn" class="btn-main" onclick="startScanner()">üì∑ ESCANEAR</button>
            <button class="btn-secondary" onclick="openSearchModal()">‚úçÔ∏è MANUAL</button>
        </div>
    </header>

    <div id="scanner-container">
        <div id="reader"></div>
        <button onclick="stopScanner()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.5); color:white; border:none; padding:8px 12px; border-radius:8px;">X</button>
    </div>

    <div class="dashboard">
        <div class="total-box">
            <small style="color:#666; font-weight:600; text-transform:uppercase; letter-spacing:1px;">Total Carrito</small>
            <div class="total-price" id="total-amount">$0</div>
            
            <div class="budget-control">
                <span>Meta: $</span>
                <input type="text" inputmode="numeric" class="budget-input" id="budget-limit" placeholder="..." oninput="handleBudgetInput(this)">
            </div>
            
            <div class="cart-actions-row">
                <button id="view-toggle-btn" class="btn-toggle-view" onclick="toggleView()">üìÇ Agrupado</button>
                <button class="btn-clear-cart" onclick="clearCart()">üóëÔ∏è Vaciar</button>
            </div>
        </div>
        <ul class="product-list" id="cart-list"></ul>
    </div>
</div>

<div id="overlay-bg" onclick="closeAllModals()"></div>

<!-- MODAL SELECCI√ìN DE UBICACI√ìN -->
<div id="location-modal" class="modal">
    <div class="modal-header"><strong>üìç Selecciona Tienda</strong></div>
    <label style="font-size:0.8rem; color:#999;">Cadena:</label>
    <select id="store-select" class="styled-select" onchange="handleStoreChange()">
        <option value="">Cargando tiendas...</option>
    </select>
    
    <label style="font-size:0.8rem; color:#999;">Sucursal:</label>
    <select id="branch-select" class="styled-select" onchange="handleBranchChange()">
        <option value="">Primero elige tienda</option>
    </select>
    
    <button class="btn-confirm" style="width:100%; margin-top:10px;" onclick="closeAllModals()">Confirmar Ubicaci√≥n</button>
</div>

<!-- MODAL B√öSQUEDA -->
<div id="search-modal" class="modal">
    <div class="modal-header"><strong>üîç Buscar Producto</strong></div>
    <input type="text" id="search-input" placeholder="Escribe nombre o c√≥digo..." onkeyup="handleSearchTyping(this.value)">
    <ul id="search-results"></ul>
    <button class="btn-confirm" id="btn-create-manual" style="display:none; margin-bottom:10px;" onclick="createManualItem()">‚ûï Crear Nuevo</button>
    <button class="btn-cancel" style="width:100%;" onclick="closeAllModals()">Cerrar</button>
</div>

<!-- MODAL PRODUCTO -->
<div id="product-modal" class="modal">
    <div class="modal-header">
        <strong>üìù Detalle Producto</strong>
        <div style="text-align: right;">
            <div id="store-label" style="font-weight:bold; color:#2e7d32;"></div>
            <div id="branch-label" style="font-size:0.7rem; color:#666;"></div>
        </div>
    </div>
    
    <div id="comparison-alert" style="display:none; padding:12px; background:#fff3e0; color:#e65100; border-radius:8px; margin-bottom:15px; font-size:0.9rem;"></div>

    <label style="font-size:0.75rem; color:#999; margin-left:5px;">C√≥digo de Barras</label>
    <input type="text" id="modal-barcode" style="background:#f9f9f9; color:#666;" disabled>
    
    <input type="text" id="inp-name" placeholder="Nombre del producto">
    <input type="text" id="inp-price" placeholder="Precio ($)" inputmode="numeric" oninput="formatCurrencyInput(this)">
    
    <div class="unit-selector">
        <button id="btn-unit-un" class="unit-option active" onclick="setUnitType('UN')">Unidad</button>
        <button id="btn-unit-kg" class="unit-option" onclick="setUnitType('KG')">Peso (Kg)</button>
    </div>

    <select id="inp-category">
        <option value="frutas">ü•¶ Frutas y Verduras</option>
        <option value="carnes">ü•© Carnes y Pescados</option>
        <option value="lacteos">üßÄ L√°cteos y Huevos</option>
        <option value="despensa">ü•´ Despensa</option>
        <option value="panaderia">üçû Panader√≠a</option>
        <option value="bebidas">ü•§ Bebidas</option>
        <option value="aseo">üßπ Aseo y Limpieza</option>
        <option value="otros">üì¶ Otros</option>
    </select>
    
    <div class="qty-wrapper">
        <div id="qty-controls-un" class="qty-controls">
            <button class="btn-qty" onclick="adjustQty(-1)">‚àí</button>
            <span id="qty-display">1</span>
            <button class="btn-qty" onclick="adjustQty(1)">+</button>
        </div>
        <div id="qty-controls-kg" class="qty-controls" style="display:none;">
            <input type="text" inputmode="numeric" id="inp-qty-kg" placeholder="0,000" oninput="formatKgInput(this)">
            <span style="font-weight:bold;">kg</span>
        </div>
    </div>
    
    <div class="modal-btns">
        <button class="btn-cancel" onclick="closeAllModals()">Cancelar</button>
        <button class="btn-confirm" onclick="saveAndAdd()">üõí Agregar</button>
    </div>
</div>

<div id="toast">Mensaje...</div>

<script>
    // ==========================================
    // ‚ö†Ô∏è CONFIGURACI√ìN DB
    // ==========================================
    const SUPABASE_URL = 'https://hviansyzbyzkfdmgujah.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2aWFuc3l6Ynl6a2ZkbWd1amFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMTA0OTAsImV4cCI6MjA4Mjc4NjQ5MH0.1_vn4udmbsQkKRrTMiRFatpfqtRyiq_5VBgdsKjJwW8';
    
    let db;
    try { db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); } catch(e) { console.error(e); }

    // --- VARIABLES DE ESTADO ---
    const CACHE_KEY = 'scanner_pro_products'; 
    const QUEUE_KEY = 'scanner_pro_queue'; 
    const CART_KEY = 'scpro_cart';
    const VIEW_KEY = 'view_pref';

    let cart = []; 
    let allStores = []; 
    let currentBranches = [];
    let currentUser = null;
    let isOnline = navigator.onLine;
    let isGrouped = localStorage.getItem(VIEW_KEY) !== 'false';
    let currentQty = 1;
    let currentUnit = 'UN';
    let html5QrCode = null;
    let isProcessing = false;

    const CATEGORIES = { 'frutas': 'ü•¶ Frutas y Verduras', 'carnes': 'ü•© Carnes y Pescados', 'lacteos': 'üßÄ L√°cteos y Huevos', 'despensa': 'ü•´ Despensa', 'panaderia': 'üçû Panader√≠a', 'bebidas': 'ü•§ Bebidas', 'aseo': 'üßπ Aseo', 'otros': 'üì¶ Otros' };
    const CAT_ORDER = ["frutas", "carnes", "lacteos", "panaderia", "despensa", "bebidas", "aseo", "otros"];

    // --- INICIALIZACI√ìN ---
    window.addEventListener('load', () => {
        loadCart();
        updateSyncUI();
    });

    window.addEventListener('online', () => { isOnline = true; updateConnectionStatus(); syncOfflineData(); });
    window.addEventListener('offline', () => { isOnline = false; updateConnectionStatus(); });

    function updateConnectionStatus() {
        const badge = document.getElementById('connection-status');
        if(badge) badge.style.display = isOnline ? 'none' : 'inline-block';
    }

    function updateSyncUI() {
        const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
        const btn = document.getElementById('sync-btn');
        if (!btn) return;
        if (queue.length > 0) { 
            btn.className = 'sync-btn pending'; 
            btn.innerHTML = `‚òÅÔ∏è ${queue.length} Pendientes`; 
        } else { 
            btn.className = 'sync-btn'; 
            btn.innerHTML = `‚òÅÔ∏è Al d√≠a`; 
        }
    }

    function addToSyncQueue(report) {
        const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]');
        queue.push(report);
        localStorage.setItem(QUEUE_KEY, JSON.stringify(queue));
        updateSyncUI();
    }

    async function syncOfflineData() {
        const queue = JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); 
        if (queue.length === 0) return;
        showToast(`Sincronizando ${queue.length} cambios...`);
        const remainingQueue = [];
        for (const item of queue) { 
            const { error } = await db.from('price_reports').insert(item); 
            if (error) remainingQueue.push(item);
        }
        localStorage.setItem(QUEUE_KEY, JSON.stringify(remainingQueue)); 
        updateSyncUI();
        if (remainingQueue.length === 0) showToast("Sincronizaci√≥n completa ‚úÖ", "success");
    }

    // --- AUTH ---
    if (db) {
        db.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                loadStores();
                renderUser();
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-content').style.display = 'none';
            }
        });
    }

    async function signInWithGoogle() {
        await db.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin + window.location.pathname } });
    }

    function renderUser() {
        const avatar = currentUser.user_metadata.avatar_url || '';
        document.getElementById('user-profile').innerHTML = `<img src="${avatar}" class="user-avatar" onclick="if(confirm('¬øSalir?')) db.auth.signOut()">`;
    }

    // --- GESTI√ìN DE TIENDAS (MODAL) ---
    async function loadStores() {
        const { data, error } = await db.from('stores').select('*').order('name');
        if (error) return showToast("Error cargando tiendas", "error");
        
        allStores = data;
        const select = document.getElementById('store-select');
        select.innerHTML = '<option value="">üè¢ Selecciona Tienda</option>';
        data.forEach(s => {
            select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        });

        const lastStore = localStorage.getItem('last_store_id');
        if (lastStore) {
            select.value = lastStore;
            await handleStoreChange();
        } else {
            updateLocationDisplay();
        }
    }

    async function handleStoreChange() {
        const storeId = document.getElementById('store-select').value;
        if (!storeId) return;

        localStorage.setItem('last_store_id', storeId);
        const { data, error } = await db.from('branches').select('*').eq('store_id', storeId).order('name');
        currentBranches = data || [];

        const branchSelect = document.getElementById('branch-select');
        branchSelect.innerHTML = '<option value="">üìç Selecciona Sucursal</option>';
        branchSelect.innerHTML += '<option value="NEW" style="color:#2e7d32; font-weight:bold;">‚ûï Nueva Sucursal...</option>';
        
        currentBranches.forEach(b => {
            branchSelect.innerHTML += `<option value="${b.id}">${b.name}</option>`;
        });

        const lastBranch = localStorage.getItem(`last_branch_${storeId}`);
        if (lastBranch) branchSelect.value = lastBranch;
        
        updateLocationDisplay();
    }

    async function handleBranchChange() {
        const branchSelect = document.getElementById('branch-select');
        const storeId = document.getElementById('store-select').value;
        
        if (branchSelect.value === 'NEW') {
            const name = prompt("Nombre de la sucursal (ej: Los Leones, √ëu√±oa):");
            if (name) {
                const { data, error } = await db.from('branches').insert({ store_id: storeId, name: name.trim() }).select().single();
                if (!error) {
                    showToast("Sucursal creada ‚úÖ");
                    await handleStoreChange();
                    branchSelect.value = data.id;
                    localStorage.setItem(`last_branch_${storeId}`, data.id);
                }
            } else { branchSelect.value = ""; }
        } else {
            localStorage.setItem(`last_branch_${storeId}`, branchSelect.value);
        }
        updateLocationDisplay();
    }

    function updateLocationDisplay() {
        const storeSelect = document.getElementById('store-select');
        const branchSelect = document.getElementById('branch-select');
        const display = document.getElementById('display-location');
        
        const storeName = storeSelect.options[storeSelect.selectedIndex]?.text.replace('üè¢ ', '') || 'Tienda';
        const branchName = branchSelect.options[branchSelect.selectedIndex]?.text.replace('üìç ', '') || 'Sucursal';
        
        if (storeSelect.value && branchSelect.value) {
            display.innerHTML = `${storeName} ‚Ä¢ ${branchName}`;
        } else {
            display.innerHTML = "Selecciona Tienda y Sucursal";
        }
    }

    function openLocationModal() {
        document.getElementById('overlay-bg').style.display = 'block';
        document.getElementById('location-modal').style.display = 'block';
    }

    // --- ESC√ÅNER ---
    function startScanner() {
        const bid = document.getElementById('branch-select').value;
        if (!bid) { openLocationModal(); return showToast("‚ö†Ô∏è Selecciona ubicaci√≥n primero"); }
        document.getElementById('scanner-container').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, onScanSuccess);
    }

    function stopScanner() {
        if(html5QrCode) html5QrCode.stop().then(() => { document.getElementById('scanner-container').style.display = 'none'; });
        else document.getElementById('scanner-container').style.display = 'none';
    }

    async function onScanSuccess(decodedText) {
        if (isProcessing) return;
        isProcessing = true;
        stopScanner();
        checkProductInDB(decodedText);
    }

    // --- B√öSQUEDA Y PRODUCTO ---
    async function checkProductInDB(barcode) {
        const branchId = document.getElementById('branch-select').value;
        showToast("üîç Buscando...");
        const { data: local } = await db.from('products').select('*').eq('barcode', barcode).eq('branch_id', branchId).maybeSingle();
        
        if (local) {
            openProductModal(local, false);
        } else {
            const { data: ref } = await db.from('products').select('*').eq('barcode', barcode).limit(1).maybeSingle();
            openProductModal(ref ? { ...ref, price: '', branch_id: branchId } : { barcode, name: '', price: '', category: 'otros', unit_type: 'UN' }, true);
        }
    }

    function openProductModal(prod, isNew) {
        const storeId = document.getElementById('store-select').value;
        const branchId = document.getElementById('branch-select').value;
        const store = allStores.find(s => s.id === storeId);
        const branch = currentBranches.find(b => b.id === branchId);

        document.getElementById('overlay-bg').style.display = 'block';
        document.getElementById('product-modal').style.display = 'block';
        
        document.getElementById('store-label').innerText = store ? store.name : '';
        document.getElementById('branch-label').innerText = branch ? branch.name : '';
        document.getElementById('modal-barcode').value = prod.barcode;
        document.getElementById('inp-name').value = prod.name || '';
        document.getElementById('inp-price').value = prod.price ? new Intl.NumberFormat('es-CL').format(prod.price) : '';
        document.getElementById('inp-category').value = prod.category || 'otros';
        
        setUnitType(prod.unit_type || 'UN');
        if(prod.price) document.getElementById('inp-price').focus(); else document.getElementById('inp-name').focus();
    }

    async function saveAndAdd() {
        const sid = document.getElementById('store-select').value;
        const bid = document.getElementById('branch-select').value;
        const store = allStores.find(s => s.id === sid);
        const branch = currentBranches.find(b => b.id === bid);
        const barcode = document.getElementById('modal-barcode').value;
        const name = document.getElementById('inp-name').value.trim();
        const price = parseInt(document.getElementById('inp-price').value.replace(/\./g, ''));
        const category = document.getElementById('inp-category').value;

        if (!name || isNaN(price)) return showToast("‚ö†Ô∏è Completa los datos");

        let qty = currentQty;
        if (currentUnit === 'KG') {
            qty = parseFloat(document.getElementById('inp-qty-kg').value.replace(',', '.'));
            if (isNaN(qty) || qty <= 0) return showToast("‚ö†Ô∏è Ingresa el peso");
        }

        const report = {
            barcode, name, price, category, unit_type: currentUnit,
            store: store.name, store_id: sid,
            branch: branch.name, branch_id: bid,
            user_id: currentUser.id
        };

        if (isOnline) {
            const { error } = await db.from('price_reports').insert(report);
            finalizeSave(report, qty, !!error);
        } else {
            addToSyncQueue(report);
            finalizeSave(report, qty, true);
        }
    }

    function finalizeSave(report, qty, offlineMode = false) { 
        const item = { ...report, id: Date.now(), qty, subtotal: Math.round(report.price * qty) };
        cart.push(item);
        saveCart();
        renderCart();
        closeAllModals();
        showToast(offlineMode ? "Guardado en local üì°" : "Producto agregado üõí", "success");
    }

    // --- UTILIDADES ---
    function formatKgInput(input) {
        let val = input.value.replace(/\D/g, '');
        if (!val) return input.value = '';
        input.value = (parseInt(val) / 1000).toFixed(3).replace('.', ',');
    }

    function formatCurrencyInput(input) {
        let val = input.value.replace(/\D/g, '');
        input.value = val ? new Intl.NumberFormat('es-CL').format(parseInt(val)) : '';
    }

    function setUnitType(type) {
        currentUnit = type;
        document.getElementById('btn-unit-un').className = type === 'UN' ? 'unit-option active' : 'unit-option';
        document.getElementById('btn-unit-kg').className = type === 'KG' ? 'unit-option active' : 'unit-option';
        document.getElementById('qty-controls-un').style.display = type === 'UN' ? 'flex' : 'none';
        document.getElementById('qty-controls-kg').style.display = type === 'KG' ? 'flex' : 'none';
    }

    function adjustQty(d) { currentQty = Math.max(1, currentQty + d); document.getElementById('qty-display').innerText = currentQty; }

    function toggleView() { isGrouped = !isGrouped; localStorage.setItem(VIEW_KEY, isGrouped); renderCart(); }

    function saveCart() { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    function loadCart() { const c = localStorage.getItem(CART_KEY); if(c) cart = JSON.parse(c); renderCart(); }
    function clearCart() { if(confirm("¬øVaciar carrito?")) { cart = []; saveCart(); renderCart(); } }

    function renderCart() {
        const list = document.getElementById('cart-list');
        list.innerHTML = '';
        let totalVal = 0;

        const renderItem = (item) => {
            totalVal += item.subtotal;
            const li = document.createElement('li');
            li.className = 'product-item';
            const qtyText = item.unit_type === 'KG' ? `${item.qty} kg` : `${item.qty}x`;
            li.innerHTML = `
                <div style="flex-grow:1;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <span style="font-weight:700;">${item.name}</span>
                        <span class="item-qty-badge">${qtyText}</span>
                    </div>
                    <small style="color:#666;">$${item.subtotal.toLocaleString('es-CL')} ($${item.price.toLocaleString('es-CL')}/${item.unit_type.toLowerCase()})</small>
                </div>
                <button class="btn-delete" onclick="removeItem(${item.id})">√ó</button>
            `;
            list.appendChild(li);
        };

        if (isGrouped) {
            const grouped = {};
            cart.forEach(i => { if(!grouped[i.category]) grouped[i.category] = []; grouped[i.category].push(i); });
            CAT_ORDER.forEach(cat => {
                if (grouped[cat]) {
                    const h = document.createElement('li'); h.className = 'category-header'; h.innerText = CATEGORIES[cat];
                    list.appendChild(h);
                    grouped[cat].forEach(renderItem);
                }
            });
        } else {
            [...cart].reverse().forEach(renderItem);
        }

        document.getElementById('total-amount').innerText = '$' + totalVal.toLocaleString('es-CL');
        document.getElementById('view-toggle-btn').innerText = isGrouped ? "üìÇ Agrupado" : "üìã Simple";
        updateTotalDisplay(totalVal);
    }

    function updateTotalDisplay(totalValue) {
        const amountEl = document.getElementById('total-amount');
        const limitValue = document.getElementById('budget-limit').value.replace(/\./g, '');
        if (limitValue && parseInt(limitValue) > 0) {
            if (totalValue > parseInt(limitValue)) amountEl.classList.add('danger');
            else amountEl.classList.remove('danger');
        } else {
            amountEl.classList.remove('danger');
        }
    }

    function handleBudgetInput(input) {
        let value = input.value.replace(/\D/g, ''); 
        if (value === '') { input.value = ''; renderCart(); return; }
        input.value = new Intl.NumberFormat('es-CL').format(parseInt(value));
        renderCart();
    }

    function removeItem(id) { cart = cart.filter(i => i.id !== id); saveCart(); renderCart(); }

    function closeAllModals() {
        document.getElementById('overlay-bg').style.display = 'none';
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        isProcessing = false;
    }

    function showToast(msg, type) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = 'show';
        setTimeout(() => t.className = '', 3000);
    }

    function openSearchModal() { 
        if (!document.getElementById('branch-select').value) { openLocationModal(); return showToast("‚ö†Ô∏è Selecciona ubicaci√≥n"); }
        document.getElementById('overlay-bg').style.display = 'block'; 
        document.getElementById('search-modal').style.display = 'block'; 
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '';
        document.getElementById('btn-create-manual').style.display = 'none';
        document.getElementById('search-input').focus(); 
    }

    function createManualItem() { 
        const text = document.getElementById('search-input').value; 
        if(!text) return; 
        closeAllModals(); 
        const code = /^\d+$/.test(text) ? text : 'MAN-' + Date.now(); 
        openProductModal({ barcode: code, name: /^\d+$/.test(text) ? "" : text, price: '', category: 'otros', unit_type: 'UN' }, true); 
    }

    let debounceTimer;
    function handleSearchTyping(text) { 
        const btn = document.getElementById('btn-create-manual'); 
        btn.style.display = text.length > 0 ? 'block' : 'none'; 
        clearTimeout(debounceTimer); 
        debounceTimer = setTimeout(() => searchInDB(text), 300); 
    }
    
    async function searchInDB(text) {
        if(text.length < 2) return;
        const storeId = document.getElementById('store-select').value;
        let query = db.from('products').select('*').limit(15);
        if (/^\d+$/.test(text)) query = query.ilike('barcode', `${text}%`); 
        else query = query.ilike('name', `%${text}%`);
        const { data } = await query;
        if (data) {
            renderSearchResults(data.filter(p => p.store_id === storeId), data.filter(p => p.store_id !== storeId));
        }
    }

    function renderSearchResults(local, external) {
        const list = document.getElementById('search-results');
        list.innerHTML = '';
        if (local.length > 0) {
            const h = document.createElement('li'); h.style.cssText = "background:#e8f5e9; color:#2e7d32; padding:5px 10px; font-size:0.8rem; font-weight:bold;"; h.innerText = "üìç En esta tienda"; list.appendChild(h);
            local.forEach(p => {
                const li = createSearchResultItem(p);
                li.onclick = () => { closeAllModals(); openProductModal(p, false); };
                list.appendChild(li);
            });
        }
        if (external.length > 0) {
            const h = document.createElement('li'); h.style.cssText = "background:#f5f5f5; color:#666; padding:5px 10px; font-size:0.8rem; font-weight:bold; margin-top:5px;"; h.innerText = "üåç Otros"; list.appendChild(h);
            external.forEach(p => {
                const li = createSearchResultItem(p);
                li.onclick = () => { closeAllModals(); openProductModal({...p, price: ''}, true); };
                list.appendChild(li);
            });
        }
    }

    function createSearchResultItem(p) {
        const li = document.createElement('li'); li.className = 'search-result-item';
        const price = p.price ? new Intl.NumberFormat('es-CL').format(p.price) : '???';
        li.innerHTML = `<div style="flex-grow:1;"><span style="font-weight:600;">${p.name}</span><br><small>${p.barcode} - ${p.branch || ''}</small></div><b>$${price}</b>`;
        return li;
    }

    function resetApp() {
        if(confirm("¬øReparar la aplicaci√≥n?\n\nEsto borrar√° la cach√© local y reiniciar√° la app.")) {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(QUEUE_KEY);
            window.location.reload();
        }
    }
</script>

</body>
</html>
